<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OGUN V6 - Security Intelligence System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: #16213e;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0f3460;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            font-size: 24px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: bold;
            color: #e94560;
            letter-spacing: 2px;
        }
        
        .version {
            font-size: 10px;
            color: #666;
            margin-left: 4px;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-badge.standby {
            background: #333;
            color: #888;
        }
        
        .status-badge.active {
            background: #1a3a1a;
            color: #4ade80;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .settings-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }
        
        /* Language Chip */
        .lang-chip {
            display: none;
            align-items: center;
            gap: 6px;
            background: #0f3460;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .lang-chip.active {
            display: flex;
        }
        
        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Transcript Area */
        .transcript {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .empty-state-title {
            font-size: 20px;
            color: #888;
            margin-bottom: 8px;
        }
        
        .empty-state-desc {
            font-size: 14px;
            max-width: 280px;
            line-height: 1.5;
        }
        
        /* Transcript Entry */
        .entry {
            background: #16213e;
            border-radius: 12px;
            padding: 12px;
            border-left: 3px solid transparent;
        }
        
        .entry.threat-low { border-left-color: #4ade80; }
        .entry.threat-medium { border-left-color: #fbbf24; }
        .entry.threat-high { border-left-color: #f97316; }
        .entry.threat-critical { 
            border-left-color: #ef4444; 
            background: #2a1a1a;
            animation: critical-pulse 1s infinite;
        }
        
        @keyframes critical-pulse {
            0%, 100% { background: #2a1a1a; }
            50% { background: #3a1a1a; }
        }
        
        .entry-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .entry-time {
            font-size: 10px;
            color: #666;
        }
        
        .entry-lang {
            font-size: 10px;
            color: #e94560;
        }
        
        .entry-badge {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .entry-badge.low { background: #166534; }
        .entry-badge.medium { background: #a16207; }
        .entry-badge.high { background: #c2410c; }
        .entry-badge.critical { background: #dc2626; }
        
        .entry-original {
            font-size: 13px;
            color: #888;
            margin-bottom: 4px;
            font-style: italic;
        }
        
        .entry-translation {
            font-size: 15px;
            color: #fff;
            line-height: 1.4;
        }
        
        .entry-threat {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #333;
        }
        
        .entry-threat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .entry-threat-level {
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .entry-threat-level.low { background: #166534; }
        .entry-threat-level.medium { background: #a16207; }
        .entry-threat-level.high { background: #c2410c; }
        .entry-threat-level.critical { background: #dc2626; }
        
        .entry-threat-confidence {
            font-size: 10px;
            color: #666;
        }
        
        .entry-threat-category {
            font-size: 12px;
            color: #e94560;
        }
        
        /* Processing Indicator */
        .processing {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: #0f3460;
            color: #888;
            font-size: 13px;
        }
        
        .processing.active {
            display: flex;
        }
        
        .processing-dot {
            width: 8px;
            height: 8px;
            background: #e94560;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .processing-dot:nth-child(1) { animation-delay: -0.32s; }
        .processing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Controls */
        .controls {
            padding: 16px;
            background: #16213e;
            border-top: 1px solid #0f3460;
        }
        
        .main-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 1px;
            transition: transform 0.1s, opacity 0.2s;
        }
        
        .main-btn:active {
            transform: scale(0.98);
        }
        
        .btn-activate {
            background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
            color: white;
        }
        
        .btn-deactivate {
            background: #333;
            color: #888;
        }
        
        .active-controls {
            display: flex;
            gap: 12px;
        }
        
        .panic-btn {
            background: #dc2626;
            color: white;
            padding: 18px 24px;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .panic-icon {
            font-size: 24px;
        }
        
        .deactivate-btn {
            flex: 1;
            background: #333;
            color: #888;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Alert Overlay */
        .alert-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(220, 38, 38, 0.95);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }
        
        .alert-overlay.active {
            display: flex;
            animation: alert-flash 0.5s infinite;
        }
        
        @keyframes alert-flash {
            0%, 100% { background: rgba(220, 38, 38, 0.95); }
            50% { background: rgba(185, 28, 28, 0.95); }
        }
        
        .alert-icon {
            font-size: 80px;
            margin-bottom: 16px;
        }
        
        .alert-level {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
            letter-spacing: 4px;
        }
        
        .alert-message {
            font-size: 18px;
            margin-bottom: 16px;
            max-width: 300px;
        }
        
        .alert-category {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 24px;
        }
        
        .alert-transcript-box {
            background: rgba(0,0,0,0.3);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            max-width: 320px;
        }
        
        .alert-transcript-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 8px;
        }
        
        .alert-transcript-text {
            font-size: 16px;
            font-style: italic;
        }
        
        .alert-location {
            font-size: 13px;
            opacity: 0.8;
            margin-bottom: 24px;
        }
        
        .alert-dismiss {
            background: white;
            color: #dc2626;
            border: none;
            padding: 16px 48px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #16213e;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #0f3460;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .setting-section {
            margin-bottom: 24px;
        }
        
        .setting-section-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .setting-group {
            margin-bottom: 16px;
        }
        
        .setting-label {
            font-size: 14px;
            margin-bottom: 6px;
            display: block;
        }
        
        .setting-input {
            width: 100%;
            padding: 12px;
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #e94560;
        }
        
        .role-selector {
            display: flex;
            gap: 8px;
        }
        
        .role-btn {
            flex: 1;
            padding: 12px;
            background: #1a1a2e;
            border: 2px solid #0f3460;
            border-radius: 8px;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .role-btn.active {
            border-color: #e94560;
            color: white;
            background: #2a1a2e;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .api-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .api-status-dot.connected { background: #4ade80; }
        .api-status-dot.disconnected { background: #ef4444; }
        
        .api-status-name {
            flex: 1;
            font-size: 13px;
        }
        
        .api-status-label {
            font-size: 11px;
            color: #888;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background: #dc2626;
        }
        
        .toast.success {
            background: #166534;
        }
        
        /* Hide elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">‚öîÔ∏è</span>
                <span class="logo-text">OGUN</span>
                <span class="version">V6</span>
            </div>
            <div class="header-actions">
                <div class="lang-chip" id="langChip">
                    <span id="langFlag">üá¨üá≠</span>
                    <span id="langName">Detecting...</span>
                </div>
                <div class="status-badge standby" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">STANDBY</span>
                </div>
                <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main">
            <div class="transcript" id="transcript">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">‚öîÔ∏è</div>
                    <div class="empty-state-title">OGUN Ready</div>
                    <div class="empty-state-desc">
                        Tap ACTIVATE to begin real-time translation and threat monitoring with GhanaNLP
                    </div>
                </div>
            </div>
            
            <div class="processing" id="processing">
                <div class="processing-dot"></div>
                <div class="processing-dot"></div>
                <div class="processing-dot"></div>
                <span>Processing audio...</span>
            </div>
        </main>
        
        <!-- Controls -->
        <div class="controls">
            <button class="main-btn btn-activate" id="btnActivate">
                ‚öîÔ∏è ACTIVATE OGUN
            </button>
            <div class="active-controls hidden" id="activeControls">
                <button class="panic-btn" id="btnPanic">
                    <span class="panic-icon">üÜò</span>
                    <span>PANIC</span>
                </button>
                <button class="deactivate-btn" id="btnDeactivate">
                    ‚ñ† DEACTIVATE
                </button>
            </div>
        </div>
    </div>
    
    <!-- Alert Overlay -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-level" id="alertLevelText">CRITICAL THREAT</div>
        <div class="alert-message" id="alertMessage">Potential danger detected</div>
        <div class="alert-category" id="alertCategory">Category: Unknown</div>
        <div class="alert-transcript-box">
            <div class="alert-transcript-label">Intercepted Speech</div>
            <div class="alert-transcript-text" id="alertTranscript">‚Äî</div>
        </div>
        <div class="alert-location" id="alertLocation">üìç Acquiring location...</div>
        <button class="alert-dismiss" id="alertDismiss">ACKNOWLEDGE</button>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">OGUN Settings</span>
                <button class="modal-close" id="closeSettings">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- API Status -->
                <div class="setting-section">
                    <div class="setting-section-title">API Status</div>
                    <div class="api-status">
                        <div class="api-status-dot connected"></div>
                        <span class="api-status-name">GhanaNLP ASR</span>
                        <span class="api-status-label">Connected</span>
                    </div>
                    <div class="api-status">
                        <div class="api-status-dot connected"></div>
                        <span class="api-status-name">GhanaNLP Translation</span>
                        <span class="api-status-label">Connected</span>
                    </div>
                    <div class="api-status">
                        <div class="api-status-dot connected"></div>
                        <span class="api-status-name">Groq (Backup)</span>
                        <span class="api-status-label">Connected</span>
                    </div>
                    <div class="api-status">
                        <div class="api-status-dot connected"></div>
                        <span class="api-status-name">Firebase</span>
                        <span class="api-status-label">Connected</span>
                    </div>
                </div>
                
                <!-- Device Info -->
                <div class="setting-section">
                    <div class="setting-section-title">Device</div>
                    <div class="setting-group">
                        <label class="setting-label">Call Sign</label>
                        <input type="text" class="setting-input" id="deviceName" placeholder="e.g., Alpha-1" value="Device-1">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Role</label>
                        <div class="role-selector">
                            <button class="role-btn active" data-role="operations">üë∑ Ops</button>
                            <button class="role-btn" data-role="security">üõ°Ô∏è Security</button>
                            <button class="role-btn" data-role="admin">üëë Admin</button>
                        </div>
                    </div>
                </div>
                
                <!-- Languages -->
                <div class="setting-section">
                    <div class="setting-section-title">Supported Languages</div>
                    <div style="font-size: 13px; color: #888; line-height: 1.6;">
                        üá¨üá≠ Twi (tw) ‚Ä¢ Ga (gaa) ‚Ä¢ Ewe (ee) ‚Ä¢ Dagbani (dag) ‚Ä¢ Hausa (ha)<br>
                        üåç Yoruba (yo) ‚Ä¢ Kikuyu (ki) ‚Ä¢ English (en)
                    </div>
                </div>
                
                <!-- Duress Code -->
                <div class="setting-section">
                    <div class="setting-section-title">Duress Code</div>
                    <div style="font-size: 13px; color: #e94560;">
                        üîê "Call my mom"
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        Speak this phrase to trigger a silent critical alert
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    
    <script>
        // ================================================================
        // OGUN V6 ‚Äî SECURITY INTELLIGENCE SYSTEM WITH GHANANLP
        // ================================================================
        
        // === CONFIGURATION ===
        const CONFIG = {
            // GhanaNLP API
            GHANANLP_KEY: '92071e0028a447f29076884ce4811942',
            GHANANLP_ASR_URL: 'https://translation-api.ghananlp.org/asr/v1/transcribe',
            GHANANLP_TRANSLATE_URL: 'https://translation-api.ghananlp.org/v1/translate',
            
            // Groq API (backup)
            GROQ_KEY: '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',
            GROQ_URL: 'https://api.groq.com/openai/v1/audio/transcriptions',
            
            // Firebase
            FIREBASE: {
                apiKey: "AIzaSyAiI07Y2Erzo7TIOoyOiXpiZIk7HoUyn8c",
                authDomain: "ogun-guardian-v1.firebaseapp.com",
                projectId: "ogun-guardian-v1",
                storageBucket: "ogun-guardian-v1.firebasestorage.app",
                messagingSenderId: "875607675728",
                appId: "1:875607675728:web:e52603a7ae927a58ead255",
                databaseURL: "https://ogun-guardian-v1-default-rtdb.europe-west1.firebasedatabase.app"
            },
            
            // Languages
            LANGUAGES: {
                'tw': { name: 'Twi', flag: 'üá¨üá≠' },
                'gaa': { name: 'Ga', flag: 'üá¨üá≠' },
                'ee': { name: 'Ewe', flag: 'üá¨üá≠' },
                'dag': { name: 'Dagbani', flag: 'üá¨üá≠' },
                'ha': { name: 'Hausa', flag: 'üá¨üá≠' },
                'yo': { name: 'Yoruba', flag: 'üá≥üá¨' },
                'ki': { name: 'Kikuyu', flag: 'üá∞üá™' },
                'en': { name: 'English', flag: 'üá¨üáß' }
            },
            
            // Duress
            DURESS_PHRASES: ['call my mom', 'call my mum', 'call my mother'],
            
            // Audio
            SAMPLE_RATE: 16000,
            CHUNK_DURATION: 5000 // 5 seconds
        };
        
        // === THREAT ONTOLOGY ===
        const THREAT_PATTERNS = [
            // CRITICAL
            { patterns: ['kill them', 'kill him', 'kill her', 'finish them', 'end them'], level: 'critical', category: 'Physical Threat' },
            { patterns: ['attack now', 'attack them', 'strike now', 'move now'], level: 'critical', category: 'Imminent Attack' },
            { patterns: ['ambush', 'trap them', 'block the road', 'cut them off'], level: 'critical', category: 'Ambush Planning' },
            { patterns: ['gun', 'pistol', 'shoot', 'cutlass', 'machete', 'weapon'], level: 'critical', category: 'Weapon Reference' },
            { patterns: ['call my mom', 'call my mum', 'call my mother'], level: 'critical', category: 'DURESS CODE' },
            
            // HIGH
            { patterns: ['follow them', 'track them', 'watch them', 'tail them'], level: 'high', category: 'Surveillance' },
            { patterns: ['take the gold', 'grab the gold', 'steal the gold'], level: 'high', category: 'Robbery Intent' },
            { patterns: ['the foreigners', 'the strangers', 'the outsiders', 'those people'], level: 'high', category: 'Team Targeting' },
            { patterns: ['tonight', 'at night', 'when dark', 'after dark'], level: 'high', category: 'Night Operation', contextRequired: ['attack', 'take', 'move'] },
            { patterns: ['call the boys', 'bring the boys', 'get the others'], level: 'high', category: 'Reinforcement Call' },
            { patterns: ['dont tell them', 'keep quiet', 'say nothing', 'secret'], level: 'high', category: 'Information Concealment' },
            { patterns: ['they trust us', 'fool them', 'trick them'], level: 'high', category: 'Trust Exploitation' },
            { patterns: ['land guard', 'security boys', 'macho men'], level: 'high', category: 'Informal Enforcement' },
            { patterns: ['speak twi', 'dont speak english', 'they dont understand'], level: 'high', category: 'Language Exclusion' },
            
            // MEDIUM
            { patterns: ['how much', 'what do they have', 'what equipment'], level: 'medium', category: 'Asset Probing' },
            { patterns: ['where are they', 'where do they stay', 'their location'], level: 'medium', category: 'Location Probing' },
            { patterns: ['how many of them', 'how many guards', 'security'], level: 'medium', category: 'Security Assessment' },
            { patterns: ['easy target', 'easy money', 'vulnerable'], level: 'medium', category: 'Vulnerability Assessment' },
            { patterns: ['they dont know', 'they suspect nothing'], level: 'medium', category: 'Knowledge Asymmetry' },
            { patterns: ['rich people', 'big money', 'foreign money'], level: 'medium', category: 'Wealth Perception' },
            { patterns: ['the vehicle', 'their car', 'the truck'], level: 'medium', category: 'Vehicle Tracking' },
            { patterns: ['galamsey', 'illegal mining', 'small scale'], level: 'medium', category: 'Mining Reference' },
            { patterns: ['bribe', 'settle', 'pay off'], level: 'medium', category: 'Corruption Reference' },
            
            // LOW
            { patterns: ['stranger', 'visitor', 'newcomer'], level: 'low', category: 'Outsider Reference' },
            { patterns: ['money', 'cash', 'payment'], level: 'low', category: 'Money Reference' },
            { patterns: ['meeting', 'gathering'], level: 'low', category: 'Group Activity' },
            { patterns: ['plan', 'idea', 'think about'], level: 'low', category: 'Planning Language' }
        ];
        
        // === STATE ===
        const state = {
            isActive: false,
            isProcessing: false,
            mediaRecorder: null,
            audioChunks: [],
            currentLanguage: null,
            location: null,
            settings: {
                deviceName: 'Device-1',
                role: 'operations'
            }
        };
        
        // === DOM ELEMENTS ===
        const elements = {
            statusBadge: document.getElementById('statusBadge'),
            statusText: document.getElementById('statusText'),
            langChip: document.getElementById('langChip'),
            langName: document.getElementById('langName'),
            langFlag: document.getElementById('langFlag'),
            transcript: document.getElementById('transcript'),
            emptyState: document.getElementById('emptyState'),
            processing: document.getElementById('processing'),
            btnActivate: document.getElementById('btnActivate'),
            btnDeactivate: document.getElementById('btnDeactivate'),
            btnPanic: document.getElementById('btnPanic'),
            activeControls: document.getElementById('activeControls'),
            alertOverlay: document.getElementById('alertOverlay'),
            alertLevelText: document.getElementById('alertLevelText'),
            alertMessage: document.getElementById('alertMessage'),
            alertCategory: document.getElementById('alertCategory'),
            alertTranscript: document.getElementById('alertTranscript'),
            alertLocation: document.getElementById('alertLocation'),
            alertDismiss: document.getElementById('alertDismiss'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettings: document.getElementById('closeSettings'),
            deviceName: document.getElementById('deviceName'),
            toast: document.getElementById('toast')
        };
        
        // === FIREBASE INITIALIZATION ===
        let database;
        try {
            firebase.initializeApp(CONFIG.FIREBASE);
            database = firebase.database();
            console.log('Firebase initialized');
        } catch (e) {
            console.error('Firebase init error:', e);
        }
        
        // === AUDIO FUNCTIONS ===
        async function startAudioCapture() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: CONFIG.SAMPLE_RATE,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                state.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4'
                });
                
                state.audioChunks = [];
                
                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        state.audioChunks.push(event.data);
                    }
                };
                
                state.mediaRecorder.onstop = async () => {
                    if (state.audioChunks.length > 0 && state.isActive) {
                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        state.audioChunks = [];
                        await processAudio(audioBlob);
                    }
                    
                    // Continue recording if still active
                    if (state.isActive && state.mediaRecorder) {
                        state.mediaRecorder.start();
                        setTimeout(() => {
                            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                                state.mediaRecorder.stop();
                            }
                        }, CONFIG.CHUNK_DURATION);
                    }
                };
                
                // Start recording
                state.mediaRecorder.start();
                setTimeout(() => {
                    if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                        state.mediaRecorder.stop();
                    }
                }, CONFIG.CHUNK_DURATION);
                
                showToast('Audio capture started', 'success');
                
            } catch (error) {
                console.error('Audio capture error:', error);
                showToast('Microphone access denied', 'error');
            }
        }
        
        function stopAudioCapture() {
            if (state.mediaRecorder) {
                if (state.mediaRecorder.state === 'recording') {
                    state.mediaRecorder.stop();
                }
                state.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                state.mediaRecorder = null;
            }
        }
        
        // === GHANANLP ASR ===
        async function transcribeWithGhanaNLP(audioBlob, language = 'tw') {
            try {
                const response = await fetch(`${CONFIG.GHANANLP_ASR_URL}?language=${language}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'audio/mpeg',
                        'Cache-Control': 'no-cache',
                        'Ocp-Apim-Subscription-Key': CONFIG.GHANANLP_KEY
                    },
                    body: audioBlob
                });
                
                if (!response.ok) {
                    throw new Error(`GhanaNLP ASR error: ${response.status}`);
                }
                
                const result = await response.text();
                return { text: result, language: language, source: 'ghananlp' };
                
            } catch (error) {
                console.error('GhanaNLP ASR error:', error);
                return null;
            }
        }
        
        // === GHANANLP TRANSLATION ===
        async function translateWithGhanaNLP(text, langPair = 'tw-en') {
            try {
                const response = await fetch(CONFIG.GHANANLP_TRANSLATE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Ocp-Apim-Subscription-Key': CONFIG.GHANANLP_KEY
                    },
                    body: JSON.stringify({
                        in: text,
                        lang: langPair
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GhanaNLP Translation error: ${response.status}`);
                }
                
                const result = await response.text();
                return result;
                
            } catch (error) {
                console.error('GhanaNLP Translation error:', error);
                return null;
            }
        }
        
        // === GROQ TRANSCRIPTION (BACKUP) ===
        async function transcribeWithGroq(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-large-v3');
                formData.append('response_format', 'json');
                
                const response = await fetch(CONFIG.GROQ_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.GROQ_KEY}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Groq error: ${response.status}`);
                }
                
                const result = await response.json();
                return { text: result.text, language: 'en', source: 'groq' };
                
            } catch (error) {
                console.error('Groq transcription error:', error);
                return null;
            }
        }
        
        // === PROCESS AUDIO ===
        async function processAudio(audioBlob) {
            if (state.isProcessing) return;
            
            state.isProcessing = true;
            elements.processing.classList.add('active');
            
            try {
                // Try GhanaNLP ASR first with different languages
                let transcription = null;
                const languages = ['tw', 'gaa', 'ee', 'dag', 'ha'];
                
                for (const lang of languages) {
                    transcription = await transcribeWithGhanaNLP(audioBlob, lang);
                    if (transcription && transcription.text && transcription.text.trim().length > 0) {
                        transcription.language = lang;
                        break;
                    }
                }
                
                // Fallback to Groq if GhanaNLP fails
                if (!transcription || !transcription.text) {
                    transcription = await transcribeWithGroq(audioBlob);
                }
                
                if (transcription && transcription.text && transcription.text.trim().length > 0) {
                    // Translate if not English
                    let translation = transcription.text;
                    if (transcription.language !== 'en' && transcription.source === 'ghananlp') {
                        const langPair = `${transcription.language}-en`;
                        const translated = await translateWithGhanaNLP(transcription.text, langPair);
                        if (translated) {
                            translation = translated;
                        }
                    }
                    
                    // Update language indicator
                    updateLanguageChip(transcription.language);
                    
                    // Analyze for threats
                    const threat = analyzeThreats(translation);
                    
                    // Add to transcript
                    addTranscriptEntry({
                        original: transcription.text,
                        translation: translation,
                        language: transcription.language,
                        threat: threat
                    });
                    
                    // Handle threats
                    if (threat && (threat.level === 'high' || threat.level === 'critical')) {
                        triggerAlert(threat, translation, transcription.text);
                    }
                    
                    // Sync to Firebase
                    syncToFirebase({
                        original: transcription.text,
                        translation: translation,
                        language: transcription.language,
                        threat: threat,
                        timestamp: Date.now(),
                        device: state.settings.deviceName
                    });
                }
                
            } catch (error) {
                console.error('Process audio error:', error);
            } finally {
                state.isProcessing = false;
                elements.processing.classList.remove('active');
            }
        }
        
        // === THREAT ANALYSIS ===
        function analyzeThreats(text) {
            if (!text) return null;
            
            const lowerText = text.toLowerCase();
            
            // Check duress code first
            for (const phrase of CONFIG.DURESS_PHRASES) {
                if (lowerText.includes(phrase)) {
                    return {
                        level: 'critical',
                        category: 'DURESS CODE ACTIVATED',
                        confidence: 100,
                        pattern: phrase
                    };
                }
            }
            
            // Check threat patterns
            let highestThreat = null;
            const levelPriority = { critical: 4, high: 3, medium: 2, low: 1 };
            
            for (const pattern of THREAT_PATTERNS) {
                for (const phrase of pattern.patterns) {
                    if (lowerText.includes(phrase)) {
                        // Check context if required
                        if (pattern.contextRequired) {
                            const hasContext = pattern.contextRequired.some(ctx => lowerText.includes(ctx));
                            if (!hasContext) continue;
                        }
                        
                        const threat = {
                            level: pattern.level,
                            category: pattern.category,
                            confidence: 85,
                            pattern: phrase
                        };
                        
                        if (!highestThreat || levelPriority[threat.level] > levelPriority[highestThreat.level]) {
                            highestThreat = threat;
                        }
                    }
                }
            }
            
            return highestThreat;
        }
        
        // === UI FUNCTIONS ===
        function updateLanguageChip(langCode) {
            const lang = CONFIG.LANGUAGES[langCode] || { name: langCode, flag: 'üåç' };
            elements.langName.textContent = lang.name;
            elements.langFlag.textContent = lang.flag;
            elements.langChip.classList.add('active');
            state.currentLanguage = langCode;
        }
        
        function addTranscriptEntry(data) {
            // Remove empty state
            if (elements.emptyState) {
                elements.emptyState.remove();
            }
            
            const entry = document.createElement('div');
            entry.className = 'entry';
            
            if (data.threat) {
                entry.classList.add(`threat-${data.threat.level}`);
            }
            
            const langInfo = CONFIG.LANGUAGES[data.language] || { name: data.language };
            const time = new Date().toLocaleTimeString();
            
            let html = `
                <div class="entry-header">
                    <span class="entry-time">${time}</span>
                    <span class="entry-lang">${langInfo.name}</span>
                    ${data.threat ? `<span class="entry-badge ${data.threat.level}">${data.threat.level.toUpperCase()}</span>` : ''}
                </div>
            `;
            
            if (data.original !== data.translation) {
                html += `<div class="entry-original">${escapeHtml(data.original)}</div>`;
            }
            
            html += `<div class="entry-translation">${escapeHtml(data.translation)}</div>`;
            
            if (data.threat) {
                html += `
                    <div class="entry-threat">
                        <div class="entry-threat-header">
                            <span class="entry-threat-level ${data.threat.level}">${data.threat.level.toUpperCase()}</span>
                            <span class="entry-threat-confidence">${data.threat.confidence}% confidence</span>
                        </div>
                        <div class="entry-threat-category">${data.threat.category}</div>
                    </div>
                `;
            }
            
            entry.innerHTML = html;
            elements.transcript.appendChild(entry);
            entry.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
        
        function triggerAlert(threat, translation, original) {
            // Vibrate
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            // Play alert sound
            playAlertSound(threat.level);
            
            // Show overlay for critical/high
            elements.alertLevelText.textContent = `${threat.level.toUpperCase()} THREAT`;
            elements.alertMessage.textContent = threat.category;
            elements.alertCategory.textContent = `Pattern: "${threat.pattern}"`;
            elements.alertTranscript.textContent = original || translation;
            
            // Get location
            if (state.location) {
                elements.alertLocation.textContent = `üìç ${state.location.lat.toFixed(4)}, ${state.location.lng.toFixed(4)}`;
            }
            
            elements.alertOverlay.classList.add('active');
            
            // Speak alert
            speak(`${threat.level} threat detected. ${threat.category}`);
        }
        
        function dismissAlert() {
            elements.alertOverlay.classList.remove('active');
        }
        
        function playAlertSound(level) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.value = level === 'critical' ? 880 : 660;
            oscillator.type = 'sine';
            gainNode.gain.value = 0.5;
            
            oscillator.start();
            
            // Beep pattern
            setTimeout(() => gainNode.gain.value = 0, 200);
            setTimeout(() => gainNode.gain.value = 0.5, 300);
            setTimeout(() => gainNode.gain.value = 0, 500);
            setTimeout(() => gainNode.gain.value = 0.5, 600);
            setTimeout(() => {
                oscillator.stop();
                audioCtx.close();
            }, 800);
        }
        
        function speak(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.1;
                speechSynthesis.speak(utterance);
            }
        }
        
        function showToast(message, type = '') {
            elements.toast.textContent = message;
            elements.toast.className = 'toast show ' + type;
            setTimeout(() => elements.toast.classList.remove('show'), 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // === FIREBASE SYNC ===
        function syncToFirebase(data) {
            if (!database) return;
            
            try {
                const alertsRef = database.ref('alerts').push();
                alertsRef.set({
                    ...data,
                    location: state.location
                });
            } catch (error) {
                console.error('Firebase sync error:', error);
            }
        }
        
        // === LOCATION ===
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        state.location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                    },
                    (error) => console.error('Location error:', error),
                    { enableHighAccuracy: true }
                );
            }
        }
        
        // === ACTIVATION ===
        function activate() {
            state.isActive = true;
            
            elements.statusBadge.classList.remove('standby');
            elements.statusBadge.classList.add('active');
            elements.statusText.textContent = 'ACTIVE';
            
            elements.btnActivate.classList.add('hidden');
            elements.activeControls.classList.remove('hidden');
            
            startAudioCapture();
            startLocationTracking();
            
            showToast('OGUN Activated', 'success');
        }
        
        function deactivate() {
            state.isActive = false;
            
            stopAudioCapture();
            
            elements.statusBadge.classList.remove('active');
            elements.statusBadge.classList.add('standby');
            elements.statusText.textContent = 'STANDBY';
            
            elements.btnActivate.classList.remove('hidden');
            elements.activeControls.classList.add('hidden');
            elements.langChip.classList.remove('active');
            
            showToast('OGUN Deactivated');
        }
        
        function triggerPanic() {
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 100, 50, 100]);
            }
            
            const panicData = {
                level: 'critical',
                category: 'MANUAL PANIC TRIGGERED',
                confidence: 100,
                pattern: 'Panic Button'
            };
            
            triggerAlert(panicData, 'Manual panic button activated', 'PANIC');
            
            syncToFirebase({
                type: 'panic',
                timestamp: Date.now(),
                device: state.settings.deviceName,
                location: state.location
            });
        }
        
        // === SETTINGS ===
        function openSettings() {
            elements.settingsModal.classList.add('active');
        }
        
        function closeSettings() {
            elements.settingsModal.classList.remove('active');
            state.settings.deviceName = elements.deviceName.value || 'Device-1';
        }
        
        // === EVENT LISTENERS ===
        elements.btnActivate.addEventListener('click', activate);
        elements.btnDeactivate.addEventListener('click', deactivate);
        elements.btnPanic.addEventListener('click', triggerPanic);
        elements.alertDismiss.addEventListener('click', dismissAlert);
        elements.settingsBtn.addEventListener('click', openSettings);
        elements.closeSettings.addEventListener('click', closeSettings);
        
        // Role selector
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.settings.role = btn.dataset.role;
            });
        });
        
        // Close modal on backdrop click
        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal) {
                closeSettings();
            }
        });
        
        // === INIT ===
        console.log('OGUN V6 initialized');
        console.log('GhanaNLP Key:', CONFIG.GHANANLP_KEY.substring(0, 8) + '...');
    </script>
</body>
</html>
