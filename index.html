<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <title>OGUN V9 CLEAN</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a25;--border:#2a2a3a;--text:#fff;--text2:#a0a0b0;--muted:#606070;--accent:#e94560;--success:#10b981;--warn:#f59e0b;--danger:#ef4444;--critical:#ff0040}
        html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text)}
        .app{display:flex;flex-direction:column;height:100vh;height:100dvh}
        
        /* Header */
        .header{background:linear-gradient(180deg,var(--bg2),var(--bg));padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--accent)}
        .logo{display:flex;align-items:center;gap:10px}
        .logo-icon{font-size:28px;filter:drop-shadow(0 0 8px rgba(233,69,96,0.5))}
        .logo-text{font-size:20px;font-weight:800;letter-spacing:3px;color:var(--accent)}
        .logo-ver{font-size:9px;color:var(--muted);letter-spacing:1px}
        .hdr-ctrl{display:flex;align-items:center;gap:8px}
        .status{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:1px;background:var(--bg3);color:var(--muted)}
        .status.on{background:rgba(16,185,129,0.2);color:var(--success);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 5px rgba(16,185,129,0.3)}50%{box-shadow:0 0 15px rgba(16,185,129,0.6)}}
        .status-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
        .status.on .status-dot{animation:blink 1s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        .btn-i{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .btn-i:hover{border-color:var(--accent);color:var(--accent)}
        .btn-i.active{background:rgba(239,68,68,0.2);border-color:var(--danger);color:var(--danger)}
        
        /* Main */
        .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .stats{display:flex;justify-content:space-around;padding:10px 16px;background:var(--bg2);border-bottom:1px solid var(--border)}
        .stat{text-align:center}
        .stat-v{font-size:18px;font-weight:700}
        .stat-l{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
        .stat-v.thr{color:var(--danger)}
        
        /* Transcript */
        .trans{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
        .empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 20px;color:var(--muted)}
        .empty-i{font-size:64px;margin-bottom:20px;opacity:0.5}
        .empty-t{font-size:18px;font-weight:600;color:var(--text2);margin-bottom:8px}
        .empty-s{font-size:13px;line-height:1.5;max-width:280px}
        
        /* Entry */
        .entry{background:var(--bg2);border-radius:12px;padding:14px;border:1px solid var(--border);animation:slideIn 0.3s}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .entry.t-low{border-left:3px solid var(--muted)}
        .entry.t-med{border-left:3px solid var(--warn);background:rgba(245,158,11,0.05)}
        .entry.t-high{border-left:3px solid var(--danger);background:rgba(239,68,68,0.08)}
        .entry.t-crit{border-left:3px solid var(--critical);background:rgba(255,0,64,0.1);box-shadow:0 0 20px rgba(255,0,64,0.3)}
        .e-hdr{display:flex;justify-content:space-between;margin-bottom:8px}
        .e-lang{font-size:12px;color:var(--text2)}
        .e-time{font-size:11px;color:var(--muted)}
        .e-orig{font-size:14px;color:var(--text2);margin-bottom:6px;font-style:italic}
        .e-trans{font-size:15px;line-height:1.4}
        .e-thr{margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
        .t-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700}
        .t-badge.low{background:rgba(96,96,112,0.2);color:var(--muted)}
        .t-badge.med{background:rgba(245,158,11,0.2);color:var(--warn)}
        .t-badge.high{background:rgba(239,68,68,0.2);color:var(--danger)}
        .t-badge.crit{background:rgba(255,0,64,0.3);color:var(--critical)}
        .t-cat{font-size:11px;color:var(--muted);margin-top:4px}
        
        /* Debug Panel */
        .dbg{position:fixed;bottom:100px;left:10px;right:10px;max-height:200px;background:rgba(0,0,0,0.95);border:1px solid var(--danger);border-radius:8px;overflow:hidden;display:none;z-index:500}
        .dbg.vis{display:block}
        .dbg-hdr{display:flex;justify-content:space-between;padding:8px 12px;background:var(--danger);color:#fff;font-size:11px;font-weight:700}
        .dbg-c{padding:8px;max-height:160px;overflow-y:auto;font-family:Monaco,Consolas,monospace;font-size:10px}
        .dbg-ln{padding:2px 0;border-bottom:1px solid #222}
        .dbg-ln.err{color:#ff6b6b}
        .dbg-ln.ok{color:#69db7c}
        .dbg-ln.info{color:#74c0fc}
        .dbg-ln.warn{color:#ffd43b}
        
        /* Controls */
        .ctrl{padding:16px;background:var(--bg2);border-top:1px solid var(--border)}
        .btn-main{width:100%;padding:16px;border-radius:12px;font-size:16px;font-weight:700;letter-spacing:2px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .btn-act{background:linear-gradient(135deg,var(--accent),#c73e54);color:#fff;box-shadow:0 4px 20px rgba(233,69,96,0.3)}
        .btn-act:hover{transform:translateY(-2px)}
        .btn-deact{background:var(--bg3);color:var(--text2);border:2px solid var(--border);display:none}
        .app.on .btn-act{display:none}
        .app.on .btn-deact{display:flex}
        .btn-row{display:flex;gap:10px;margin-top:10px}
        .btn-sec{flex:1;padding:12px;border-radius:10px;font-size:12px;font-weight:600;border:1px solid var(--border);background:var(--bg3);color:var(--text2);cursor:pointer}
        .btn-sec:hover{border-color:var(--accent);color:var(--accent)}
        .btn-panic{background:rgba(255,0,64,0.1);border-color:var(--critical);color:var(--critical)}
        .btn-panic:hover{background:var(--critical);color:#fff}
        
        /* Alert Overlay */
        .alert-ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.98);z-index:1000;display:none;flex-direction:column;overflow-y:auto}
        .alert-ov.vis{display:flex}
        .a-hdr{padding:20px;text-align:center;background:linear-gradient(180deg,var(--critical),rgba(255,0,64,0.3))}
        .a-icon{font-size:48px;margin-bottom:10px}
        .a-level{font-size:24px;font-weight:800;letter-spacing:4px;color:#fff}
        .a-cat{font-size:14px;color:rgba(255,255,255,0.8);margin-top:5px}
        .a-content{flex:1;padding:20px}
        .a-sec{margin-bottom:20px}
        .a-sec-t{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
        .a-box{background:var(--bg2);border-radius:10px;padding:14px;border:1px solid var(--border)}
        .a-txt{font-size:15px;line-height:1.5}
        .a-trl{font-size:14px;color:var(--text2);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
        .a-coords{font-family:Monaco,monospace;font-size:13px;color:var(--success)}
        .a-addr{font-size:14px;color:var(--text2);margin-top:6px}
        .a-map{width:100%;height:180px;border-radius:8px;margin-top:10px;border:none;background:var(--bg3)}
        .btn-dir{width:100%;padding:12px;margin-top:10px;background:var(--success);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer}
        .a-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
        .a-row:last-child{border-bottom:none}
        .a-lbl{color:var(--muted);font-size:13px}
        .a-val{font-size:13px;font-weight:600}
        .a-acts{padding:20px;display:flex;flex-direction:column;gap:10px;background:var(--bg2);border-top:1px solid var(--border)}
        .btn-a{width:100%;padding:16px;border-radius:10px;font-size:14px;font-weight:700;border:none;cursor:pointer}
        .btn-dismiss{background:var(--bg3);color:var(--text2);border:1px solid var(--border)}
        .btn-false{background:rgba(245,158,11,0.2);color:var(--warn);border:1px solid var(--warn)}
        .btn-call{background:var(--critical);color:#fff}
        
        /* Setup Modal */
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px}
        .modal.vis{display:flex}
        .m-box{width:100%;max-width:400px;max-height:90vh;background:var(--bg2);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
        .m-hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--bg3);border-bottom:1px solid var(--border)}
        .m-title{font-size:16px;font-weight:700}
        .m-close{width:32px;height:32px;border:none;background:transparent;color:var(--muted);font-size:24px;cursor:pointer}
        .m-body{flex:1;overflow-y:auto;padding:20px}
        .m-ftr{padding:16px 20px;background:var(--bg3);border-top:1px solid var(--border)}
        .s-grp{margin-bottom:20px}
        .s-lbl{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px}
        .s-inp{width:100%;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
        .s-inp:focus{outline:none;border-color:var(--accent)}
        .s-sel{width:100%;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
        .s-hint{font-size:11px;color:var(--muted);margin-top:4px}
        .s-status{padding:8px 12px;border-radius:6px;font-size:12px;margin-top:8px}
        .s-status.ok{background:rgba(16,185,129,0.2);color:var(--success)}
        .s-status.err{background:rgba(239,68,68,0.2);color:var(--danger)}
        .s-status.pending{background:rgba(245,158,11,0.2);color:var(--warn)}
        .btn-save{width:100%;padding:14px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer}
        .btn-save:disabled{background:var(--muted);cursor:not-allowed}
        
        /* Toast */
        .toast{position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(100px);padding:12px 24px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;font-size:13px;z-index:3000;opacity:0;transition:all 0.3s}
        .toast.vis{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.ok{border-color:var(--success);background:rgba(16,185,129,0.1)}
        .toast.err{border-color:var(--danger);background:rgba(239,68,68,0.1)}
        .toast.warn{border-color:var(--warn);background:rgba(245,158,11,0.1)}
        
        /* Processing */
        .proc{position:fixed;top:70px;right:16px;display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--bg2);border:1px solid var(--accent);border-radius:20px;font-size:11px;color:var(--accent);opacity:0;z-index:100}
        .proc.vis{opacity:1}
        .proc-spin{width:12px;height:12px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Key Missing Warning */
        .key-warn{background:rgba(245,158,11,0.1);border:1px solid var(--warn);border-radius:10px;padding:12px;margin:16px;text-align:center}
        .key-warn-t{font-size:14px;font-weight:600;color:var(--warn);margin-bottom:4px}
        .key-warn-s{font-size:12px;color:var(--text2)}
    </style>
</head>
<body>
<div class="app" id="app">
    <header class="header">
        <div class="logo">
            <span class="logo-icon">‚öîÔ∏è</span>
            <div>
                <div class="logo-text">OGUN</div>
                <div class="logo-ver">V9 CLEAN</div>
            </div>
        </div>
        <div class="hdr-ctrl">
            <div class="status" id="status">
                <span class="status-dot"></span>
                <span id="statusTxt">STANDBY</span>
            </div>
            <button class="btn-i" id="btnDbg" title="Debug">üêõ</button>
            <button class="btn-i" id="btnSet" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>
    
    <div class="proc" id="proc"><div class="proc-spin"></div><span>Processing...</span></div>
    
    <main class="main">
        <div class="stats">
            <div class="stat"><div class="stat-v" id="sRun">00:00</div><div class="stat-l">Runtime</div></div>
            <div class="stat"><div class="stat-v" id="sProc">0</div><div class="stat-l">Processed</div></div>
            <div class="stat"><div class="stat-v thr" id="sThr">0</div><div class="stat-l">Threats</div></div>
            <div class="stat"><div class="stat-v" id="sLang">--</div><div class="stat-l">Lang</div></div>
        </div>
        
        <div id="keyWarn" class="key-warn" style="display:none">
            <div class="key-warn-t">‚ö†Ô∏è API Keys Required</div>
            <div class="key-warn-s">Go to Settings to enter your Groq and GhanaNLP keys</div>
        </div>
        
        <div class="trans" id="trans">
            <div class="empty" id="empty">
                <div class="empty-i">üõ°Ô∏è</div>
                <div class="empty-t">OGUN Security Intelligence</div>
                <div class="empty-s">Tap ACTIVATE to begin real-time threat detection.<br><br><strong>50+ operators protected</strong></div>
            </div>
        </div>
    </main>
    
    <div class="dbg" id="dbg">
        <div class="dbg-hdr"><span>üêõ DEBUG CONSOLE</span><span id="dbgCnt">0</span></div>
        <div class="dbg-c" id="dbgC"></div>
    </div>
    
    <div class="ctrl">
        <button class="btn-main btn-act" id="btnAct"><span>‚öîÔ∏è</span><span>ACTIVATE OGUN</span></button>
        <button class="btn-main btn-deact" id="btnDeact"><span>‚ñ†</span><span>DEACTIVATE</span></button>
        <div class="btn-row">
            <button class="btn-sec" id="btnExp">üìã Export</button>
            <button class="btn-sec btn-panic" id="btnPanic">üö® PANIC</button>
        </div>
    </div>
</div>

<!-- Alert Overlay -->
<div class="alert-ov" id="alertOv">
    <div class="a-hdr" id="aHdr">
        <div class="a-icon">‚ö†Ô∏è</div>
        <div class="a-level" id="aLevel">THREAT DETECTED</div>
        <div class="a-cat" id="aCat">Category</div>
    </div>
    <div class="a-content">
        <div class="a-sec">
            <div class="a-sec-t">üìù Intercepted</div>
            <div class="a-box">
                <div class="a-txt" id="aTxt">--</div>
                <div class="a-trl" id="aTrl">--</div>
            </div>
        </div>
        <div class="a-sec">
            <div class="a-sec-t">üìç Location</div>
            <div class="a-box">
                <div class="a-coords" id="aCoords">Acquiring GPS...</div>
                <div class="a-addr" id="aAddr">Resolving...</div>
                <iframe id="aMap" class="a-map" frameborder="0" allowfullscreen loading="lazy"></iframe>
                <button class="btn-dir" id="btnDir">üß≠ GET DIRECTIONS</button>
            </div>
        </div>
        <div class="a-sec">
            <div class="a-sec-t">‚ÑπÔ∏è Details</div>
            <div class="a-box">
                <div class="a-row"><span class="a-lbl">Time</span><span class="a-val" id="aTime">--</span></div>
                <div class="a-row"><span class="a-lbl">Confidence</span><span class="a-val" id="aConf">--</span></div>
                <div class="a-row"><span class="a-lbl">Device</span><span class="a-val" id="aDev">--</span></div>
            </div>
        </div>
    </div>
    <div class="a-acts">
        <button class="btn-a btn-call" id="btnCall">üìû CALL SECURITY</button>
        <button class="btn-a btn-false" id="btnFalse">‚ö†Ô∏è FALSE ALARM</button>
        <button class="btn-a btn-dismiss" id="btnDismiss">DISMISS</button>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="setModal">
    <div class="m-box">
        <div class="m-hdr">
            <span class="m-title">‚öôÔ∏è Settings</span>
            <button class="m-close" id="mClose">√ó</button>
        </div>
        <div class="m-body">
            <div class="s-grp">
                <label class="s-lbl">Device Name</label>
                <input type="text" class="s-inp" id="sDevName" placeholder="e.g., Alpha-1">
                <div class="s-hint">Identifies this device in alerts</div>
            </div>
            <div class="s-grp">
                <label class="s-lbl">Groq API Key *</label>
                <input type="password" class="s-inp" id="sGroqKey" placeholder="gsk_...">
                <div class="s-hint">Get free key at console.groq.com</div>
                <div class="s-status pending" id="groqStatus">Not configured</div>
            </div>
            <div class="s-grp">
                <label class="s-lbl">GhanaNLP API Key</label>
                <input type="password" class="s-inp" id="sGnlpKey" placeholder="Enter key">
                <div class="s-hint">For Ghanaian language translation</div>
                <div class="s-status pending" id="gnlpStatus">Not configured</div>
            </div>
            <div class="s-grp">
                <label class="s-lbl">Security Phone</label>
                <input type="tel" class="s-inp" id="sPhone" placeholder="+233...">
                <div class="s-hint">Number for emergency calls</div>
            </div>
            <div class="s-grp">
                <label class="s-lbl">Whisper Model</label>
                <select class="s-sel" id="sModel">
                    <option value="whisper-large-v3-turbo">Turbo (Faster)</option>
                    <option value="whisper-large-v3">Large V3 (Accurate)</option>
                </select>
            </div>
            <div class="s-grp">
                <label class="s-lbl">Audio Chunk Duration</label>
                <select class="s-sel" id="sChunk">
                    <option value="4000">4 seconds</option>
                    <option value="5000">5 seconds</option>
                    <option value="6000">6 seconds</option>
                </select>
            </div>
        </div>
        <div class="m-ftr">
            <button class="btn-save" id="btnSave">Save Settings</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OGUN V9 CLEAN - Keys in Settings, Never Hardcoded
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const CFG = {
    GROQ_URL: 'https://api.groq.com/openai/v1/audio/transcriptions',
    GHANANLP_URL: 'https://translation-api.ghananlp.org/v1/translate',
    FB: {
        apiKey: "AIzaSyAiI07Y2Erzo7TIOoyOiXpiZIk7HoUyn8c",
        authDomain: "ogun-guardian-v1.firebaseapp.com",
        projectId: "ogun-guardian-v1",
        storageBucket: "ogun-guardian-v1.firebasestorage.app",
        messagingSenderId: "875607675728",
        appId: "1:875607675728:web:e52603a7ae927a58ead255",
        databaseURL: "https://ogun-guardian-v1-default-rtdb.europe-west1.firebasedatabase.app"
    },
    DURESS: ['call my mom','call my mum','call my mother','phone my mom','i need to call home','fre me maame','fr…õ me maame'],
    LANGS: {
        tw:{n:'Twi',f:'üá¨üá≠',p:'tw-en'},
        ee:{n:'Ewe',f:'üá¨üá≠',p:'ee-en'},
        gaa:{n:'Ga',f:'üá¨üá≠',p:'gaa-en'},
        dag:{n:'Dagbani',f:'üá¨üá≠',p:'dag-en'},
        ha:{n:'Hausa',f:'üá≥üá¨',p:'ha-en'},
        yo:{n:'Yoruba',f:'üá≥üá¨',p:'yo-en'},
        en:{n:'English',f:'üåç',p:null}
    }
};

// Threat patterns
const TH = {
    critical:[
        {p:/\b(kill|murder|execute|eliminate)\s+(them|him|her|those|the)/i,c:'LETHAL INTENT',w:100},
        {p:/\b(shoot|stab|slash|attack)\s+(them|him|her|those|the)/i,c:'ASSAULT',w:95},
        {p:/\bkum\s*(won|w…în|no|them)/i,c:'TWI: KILL',w:100},
        {p:/\b(koom|coom)\s*(won|one|wan)/i,c:'TWI-PHONETIC: KILL',w:95},
        {p:/\b(gun|pistol|rifle|weapon)\b/i,c:'FIREARM',w:94},
        {p:/\b(knife|cutlass|machete|blade)\b/i,c:'BLADE',w:90},
        {p:/\btuo\b/i,c:'TWI: GUN',w:94},
        {p:/\bsekan\b/i,c:'TWI: KNIFE',w:91},
        {p:/\bambush\b/i,c:'AMBUSH',w:93},
        {p:/\bblock\s*(the\s*)?(road|path|exit)/i,c:'BLOCK ESCAPE',w:92},
        {p:/\bno\s*witness/i,c:'NO WITNESS',w:96}
    ],
    high:[
        {p:/\b(follow|track|watch)\s+(them|him|her)/i,c:'SURVEILLANCE',w:80},
        {p:/\bwhere\s+(do\s+)?(they|he|she)\s+(stay|live|go)/i,c:'LOCATION PROBE',w:78},
        {p:/\bwhen\s+(do\s+)?(they|he|she)\s+(leave|come)/i,c:'TIMING PROBE',w:76},
        {p:/\b(take|steal|grab)\s*(the\s*)?(gold|equipment|money)/i,c:'THEFT',w:82},
        {p:/\bsika\b/i,c:'TWI: MONEY',w:65},
        {p:/\bcall\s*(the\s*)?(boys|guys|gang)/i,c:'BACKUP',w:80},
        {p:/\bobroni\b/i,c:'TWI: FOREIGNER',w:68}
    ],
    medium:[
        {p:/\bdon['']?t\s+tell/i,c:'SECRECY',w:65},
        {p:/\bgalamsey\b/i,c:'ILLEGAL MINING',w:50},
        {p:/\beasy\s+target/i,c:'EASY TARGET',w:68}
    ],
    low:[
        {p:/\bpolice\b/i,c:'POLICE',w:30},
        {p:/\bsecurity\b/i,c:'SECURITY',w:25}
    ]
};

// State
const S = {
    active: false,
    processing: false,
    rec: null,
    chunks: [],
    loc: null,
    addr: '',
    start: null,
    runInt: null,
    stats: {proc:0, thr:0},
    dbgLog: [],
    db: null,
    // Keys loaded from localStorage
    keys: {
        groq: localStorage.getItem('ogun_groq_key') || '',
        gnlp: localStorage.getItem('ogun_gnlp_key') || ''
    },
    set: {
        dev: localStorage.getItem('ogun_dev') || 'Device-1',
        phone: localStorage.getItem('ogun_phone') || '',
        model: localStorage.getItem('ogun_model') || 'whisper-large-v3-turbo',
        chunk: parseInt(localStorage.getItem('ogun_chunk')) || 5000
    }
};

const $ = id => document.getElementById(id);
const D = {
    app:$('app'), status:$('status'), statusTxt:$('statusTxt'),
    btnAct:$('btnAct'), btnDeact:$('btnDeact'), btnDbg:$('btnDbg'), btnSet:$('btnSet'),
    trans:$('trans'), empty:$('empty'), proc:$('proc'),
    dbg:$('dbg'), dbgC:$('dbgC'), dbgCnt:$('dbgCnt'),
    alertOv:$('alertOv'), setModal:$('setModal'), toast:$('toast'),
    sRun:$('sRun'), sProc:$('sProc'), sThr:$('sThr'), sLang:$('sLang'),
    keyWarn:$('keyWarn')
};

// Init
document.addEventListener('DOMContentLoaded', init);

function init() {
    dbg('OGUN V9 CLEAN initializing...', 'info');
    
    // Firebase
    try {
        firebase.initializeApp(CFG.FB);
        S.db = firebase.database();
        dbg('Firebase connected', 'ok');
    } catch(e) {
        dbg('Firebase error: ' + e.message, 'err');
    }
    
    // Check keys
    checkKeys();
    
    // Location
    getLoc();
    
    // Events
    D.btnAct.onclick = activate;
    D.btnDeact.onclick = deactivate;
    D.btnDbg.onclick = toggleDbg;
    D.btnSet.onclick = openSettings;
    $('mClose').onclick = () => D.setModal.classList.remove('vis');
    $('btnSave').onclick = saveSettings;
    $('btnPanic').onclick = triggerPanic;
    $('btnExp').onclick = exportLog;
    $('btnDismiss').onclick = dismissAlert;
    $('btnFalse').onclick = () => dismissAlert('false');
    $('btnCall').onclick = callSec;
    $('btnDir').onclick = openDir;
    
    // Load settings into form
    loadSettingsForm();
    
    dbg('Init complete', 'ok');
    toast('OGUN V9 Ready', 'ok');
}

function checkKeys() {
    if (!S.keys.groq) {
        D.keyWarn.style.display = 'block';
        dbg('WARNING: Groq API key not set', 'warn');
    } else {
        D.keyWarn.style.display = 'none';
        dbg('Groq key loaded from storage', 'ok');
    }
    if (S.keys.gnlp) {
        dbg('GhanaNLP key loaded from storage', 'ok');
    }
}

function openSettings() {
    loadSettingsForm();
    D.setModal.classList.add('vis');
}

function loadSettingsForm() {
    $('sDevName').value = S.set.dev;
    $('sGroqKey').value = S.keys.groq;
    $('sGnlpKey').value = S.keys.gnlp;
    $('sPhone').value = S.set.phone;
    $('sModel').value = S.set.model;
    $('sChunk').value = S.set.chunk;
    
    // Update status indicators
    $('groqStatus').textContent = S.keys.groq ? '‚úì Key saved' : 'Not configured';
    $('groqStatus').className = 's-status ' + (S.keys.groq ? 'ok' : 'pending');
    $('gnlpStatus').textContent = S.keys.gnlp ? '‚úì Key saved' : 'Optional - not set';
    $('gnlpStatus').className = 's-status ' + (S.keys.gnlp ? 'ok' : 'pending');
}

function saveSettings() {
    // Get values
    S.set.dev = $('sDevName').value || 'Device-1';
    S.keys.groq = $('sGroqKey').value.trim();
    S.keys.gnlp = $('sGnlpKey').value.trim();
    S.set.phone = $('sPhone').value.trim();
    S.set.model = $('sModel').value;
    S.set.chunk = parseInt($('sChunk').value);
    
    // Save to localStorage
    localStorage.setItem('ogun_dev', S.set.dev);
    localStorage.setItem('ogun_groq_key', S.keys.groq);
    localStorage.setItem('ogun_gnlp_key', S.keys.gnlp);
    localStorage.setItem('ogun_phone', S.set.phone);
    localStorage.setItem('ogun_model', S.set.model);
    localStorage.setItem('ogun_chunk', S.set.chunk);
    
    // Update UI
    checkKeys();
    D.setModal.classList.remove('vis');
    
    dbg('Settings saved', 'ok');
    toast('Settings saved', 'ok');
}

async function activate() {
    // Check for Groq key
    if (!S.keys.groq) {
        toast('Enter Groq API key in Settings first', 'err');
        openSettings();
        return;
    }
    
    dbg('Activating...', 'info');
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            audio: {echoCancellation:true, noiseSuppression:true, autoGainControl:true}
        });
        
        dbg('Microphone access granted', 'ok');
        
        const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
            ? 'audio/webm;codecs=opus' 
            : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
        
        dbg('MIME: ' + mime, 'info');
        
        S.rec = new MediaRecorder(stream, {mimeType: mime});
        S.chunks = [];
        
        S.rec.ondataavailable = e => {
            if (e.data && e.data.size > 0) S.chunks.push(e.data);
        };
        
        S.rec.onstop = async () => {
            if (S.chunks.length > 0 && S.active) {
                const blob = new Blob(S.chunks, {type: mime});
                S.chunks = [];
                if (blob.size > 1000) await processAudio(blob);
            }
            if (S.active && S.rec && S.rec.state === 'inactive') {
                S.chunks = [];
                try {
                    S.rec.start();
                    setTimeout(() => {
                        if (S.rec && S.rec.state === 'recording') S.rec.stop();
                    }, S.set.chunk);
                } catch(e) {
                    dbg('Restart error: ' + e.message, 'err');
                }
            }
        };
        
        S.rec.start();
        setTimeout(() => {
            if (S.rec && S.rec.state === 'recording') S.rec.stop();
        }, S.set.chunk);
        
        S.active = true;
        S.start = Date.now();
        D.app.classList.add('on');
        D.status.classList.add('on');
        D.statusTxt.textContent = 'ACTIVE';
        D.empty.style.display = 'none';
        S.runInt = setInterval(updateRun, 1000);
        
        logFB('activation', {dev: S.set.dev});
        dbg('OGUN activated - listening', 'ok');
        toast('OGUN Activated', 'ok');
        
        // Wake lock
        if ('wakeLock' in navigator) {
            try {
                await navigator.wakeLock.request('screen');
                dbg('Wake lock acquired', 'ok');
            } catch(e) {}
        }
        
    } catch(e) {
        dbg('Activation error: ' + e.message, 'err');
        toast('Mic access denied', 'err');
    }
}

function deactivate() {
    dbg('Deactivating...', 'info');
    S.active = false;
    
    if (S.rec) {
        if (S.rec.state === 'recording') S.rec.stop();
        S.rec.stream.getTracks().forEach(t => t.stop());
        S.rec = null;
    }
    
    if (S.runInt) {
        clearInterval(S.runInt);
        S.runInt = null;
    }
    
    D.app.classList.remove('on');
    D.status.classList.remove('on');
    D.statusTxt.textContent = 'STANDBY';
    
    logFB('deactivation', {dev: S.set.dev, runtime: D.sRun.textContent});
    dbg('OGUN deactivated', 'info');
    toast('Deactivated', 'warn');
}

async function processAudio(blob) {
    if (S.processing) return;
    S.processing = true;
    D.proc.classList.add('vis');
    
    dbg('Processing (' + Math.round(blob.size/1024) + 'KB)...', 'info');
    
    try {
        // Transcribe
        const tr = await transcribe(blob);
        if (!tr || !tr.text || tr.text.trim().length < 2) {
            dbg('No speech detected', 'info');
            S.processing = false;
            D.proc.classList.remove('vis');
            return;
        }
        
        dbg('Transcript: ' + tr.text.substring(0, 80), 'info');
        
        // Translate if needed
        let trl = null;
        const lang = detectLang(tr.text);
        if (lang && lang !== 'en') {
            trl = await translate(tr.text, lang);
        }
        
        // Analyze
        const threat = analyze(tr.text, trl);
        
        // Check duress
        if (checkDuress(tr.text)) {
            threat.level = 'critical';
            threat.cat = 'DURESS CODE';
            threat.w = 100;
        }
        
        // Add entry
        addEntry({
            orig: tr.text,
            trl: trl,
            lang: lang || 'en',
            threat: threat,
            time: new Date().toLocaleTimeString()
        });
        
        // Update stats
        S.stats.proc++;
        D.sProc.textContent = S.stats.proc;
        D.sLang.textContent = CFG.LANGS[lang]?.n || 'EN';
        
        // Handle threat
        if (threat.level !== 'none') {
            handleThreat(threat, tr.text, trl);
        }
        
    } catch(e) {
        dbg('Process error: ' + e.message, 'err');
    }
    
    S.processing = false;
    D.proc.classList.remove('vis');
}

async function transcribe(blob) {
    try {
        const fd = new FormData();
        fd.append('file', blob, 'audio.webm');
        fd.append('model', S.set.model);
        fd.append('response_format', 'json');
        fd.append('prompt', 'Twi, Akan, Ewe, Ga, Hausa, Yoruba, Ghana, African');
        
        const r = await fetch(CFG.GROQ_URL, {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + S.keys.groq},
            body: fd
        });
        
        if (!r.ok) {
            const errTxt = await r.text();
            throw new Error('Groq ' + r.status + ': ' + errTxt.substring(0, 100));
        }
        
        const d = await r.json();
        dbg('Groq OK', 'ok');
        return d;
        
    } catch(e) {
        dbg('Groq error: ' + e.message, 'err');
        return null;
    }
}

async function translate(text, lang) {
    // Try GhanaNLP first
    if (S.keys.gnlp) {
        const gnlp = await translateGNLP(text, lang);
        if (gnlp) return gnlp;
    }
    
    // Fallback to Google
    return await translateGoogle(text, lang);
}

async function translateGNLP(text, lang) {
    try {
        const lc = CFG.LANGS[lang];
        if (!lc || !lc.p) return null;
        
        const r = await fetch(CFG.GHANANLP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Ocp-Apim-Subscription-Key': S.keys.gnlp
            },
            body: JSON.stringify({in: text, lang: lc.p})
        });
        
        if (!r.ok) throw new Error('GNLP ' + r.status);
        
        const t = await r.text();
        dbg('GhanaNLP OK', 'ok');
        return t;
        
    } catch(e) {
        dbg('GhanaNLP error: ' + e.message, 'warn');
        return null;
    }
}

async function translateGoogle(text, lang) {
    try {
        const url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=' + lang + '&tl=en&dt=t&q=' + encodeURIComponent(text);
        const r = await fetch(url);
        if (!r.ok) throw new Error('Google ' + r.status);
        const d = await r.json();
        const trl = d[0].map(i => i[0]).join('');
        dbg('Google OK', 'ok');
        return trl;
    } catch(e) {
        dbg('Google error: ' + e.message, 'warn');
        return null;
    }
}

function detectLang(text) {
    if (/[…õ…î≈ã∆ê∆Ü≈ä]/.test(text)) return 'tw';
    const twi = ['wo','me','y…õ','na','no','won','w…în','s…õ','nso','de…õ','k…î','bra','hw…õ'];
    const lt = text.toLowerCase();
    let ts = 0;
    twi.forEach(w => { if (lt.includes(w)) ts++; });
    if (ts >= 2) return 'tw';
    return 'en';
}

function analyze(orig, trl) {
    let lvl = 'none', w = 0, cat = '';
    const texts = [orig];
    if (trl) texts.push(trl);
    
    for (const txt of texts) {
        for (const lv of ['critical','high','medium','low']) {
            if (TH[lv]) {
                for (const pt of TH[lv]) {
                    if (pt.p.test(txt) && pt.w > w) {
                        w = pt.w;
                        lvl = lv;
                        cat = pt.c;
                    }
                }
            }
        }
    }
    return {level: lvl, w: w, cat: cat};
}

function checkDuress(text) {
    const lt = text.toLowerCase();
    for (const c of CFG.DURESS) {
        if (lt.includes(c.toLowerCase())) {
            dbg('DURESS: ' + c, 'err');
            return true;
        }
    }
    return false;
}

function handleThreat(th, orig, trl) {
    S.stats.thr++;
    D.sThr.textContent = S.stats.thr;
    
    dbg('THREAT: ' + th.level.toUpperCase() + ' - ' + th.cat, 'err');
    
    logFB('threat', {
        level: th.level,
        cat: th.cat,
        text: orig,
        trl: trl,
        dev: S.set.dev,
        loc: S.loc
    });
    
    if (th.level === 'critical' || th.level === 'high') {
        showAlert(th, orig, trl);
        playAlarm(th.level);
        if (navigator.vibrate) {
            navigator.vibrate(th.level === 'critical' ? [500,200,500,200,500] : [300,100,300]);
        }
    } else if (th.level === 'medium') {
        playBeep();
        if (navigator.vibrate) navigator.vibrate([200,100,200]);
    }
}

function showAlert(th, orig, trl) {
    $('aLevel').textContent = th.level.toUpperCase() + ' THREAT';
    $('aCat').textContent = th.cat;
    $('aTxt').textContent = orig;
    $('aTrl').textContent = trl || 'No translation';
    $('aTime').textContent = new Date().toLocaleString();
    $('aConf').textContent = th.w + '%';
    $('aDev').textContent = S.set.dev;
    
    if (S.loc) {
        $('aCoords').textContent = S.loc.lat.toFixed(6) + ', ' + S.loc.lng.toFixed(6);
        $('aAddr').textContent = S.addr || 'Resolving...';
        $('aMap').src = 'https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=' + S.loc.lat + ',' + S.loc.lng + '&zoom=15';
    }
    
    const hdr = $('aHdr');
    hdr.style.background = th.level === 'critical' 
        ? 'linear-gradient(180deg,#ff0040,rgba(255,0,64,0.3))'
        : 'linear-gradient(180deg,#ef4444,rgba(239,68,68,0.3))';
    
    D.alertOv.classList.add('vis');
}

function dismissAlert(reason) {
    D.alertOv.classList.remove('vis');
    if (reason === 'false') {
        logFB('false_alarm', {dev: S.set.dev});
        toast('Marked false alarm', 'warn');
    }
}

function callSec() {
    const phone = S.set.phone || '+233000000000';
    window.location.href = 'tel:' + phone;
}

function openDir() {
    if (S.loc) {
        window.open('https://www.google.com/maps/dir/?api=1&destination=' + S.loc.lat + ',' + S.loc.lng, '_blank');
    }
}

function triggerPanic() {
    dbg('PANIC BUTTON', 'err');
    logFB('panic', {dev: S.set.dev, loc: S.loc});
    showAlert({level:'critical', cat:'MANUAL PANIC', w:100}, 'PANIC ACTIVATED', 'Emergency');
    playAlarm('critical');
    if (navigator.vibrate) navigator.vibrate([1000,200,1000,200,1000]);
}

function addEntry(d) {
    D.empty.style.display = 'none';
    
    const e = document.createElement('div');
    const lc = d.threat.level === 'none' ? '' : 't-' + (d.threat.level === 'critical' ? 'crit' : d.threat.level);
    e.className = 'entry ' + lc;
    
    const li = CFG.LANGS[d.lang] || {n:'?', f:'üåç'};
    
    let h = '<div class="e-hdr"><span class="e-lang">' + li.f + ' ' + li.n + '</span><span class="e-time">' + d.time + '</span></div>';
    h += '<div class="e-orig">"' + esc(d.orig) + '"</div>';
    if (d.trl) h += '<div class="e-trans">' + esc(d.trl) + '</div>';
    
    if (d.threat.level && d.threat.level !== 'none') {
        const bc = d.threat.level === 'critical' ? 'crit' : d.threat.level;
        const ic = {critical:'üö®', high:'‚ö†Ô∏è', medium:'‚ö°', low:'‚ÑπÔ∏è'}[d.threat.level] || '';
        h += '<div class="e-thr"><span class="t-badge ' + bc + '">' + ic + ' ' + d.threat.level.toUpperCase() + '</span>';
        h += '<div class="t-cat">' + d.threat.cat + '</div></div>';
    }
    
    e.innerHTML = h;
    D.trans.appendChild(e);
    e.scrollIntoView({behavior:'smooth', block:'end'});
}

function updateRun() {
    if (!S.start) return;
    const el = Math.floor((Date.now() - S.start) / 1000);
    D.sRun.textContent = String(Math.floor(el/60)).padStart(2,'0') + ':' + String(el%60).padStart(2,'0');
}

function playBeep() {
    try {
        const c = new (window.AudioContext || window.webkitAudioContext)();
        const o = c.createOscillator();
        const g = c.createGain();
        o.connect(g); g.connect(c.destination);
        o.frequency.value = 800; g.gain.value = 0.3;
        o.start(); setTimeout(() => o.stop(), 200);
    } catch(e) {}
}

function playAlarm(lv) {
    try {
        const c = new (window.AudioContext || window.webkitAudioContext)();
        const fr = lv === 'critical' ? 880 : 660;
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const o = c.createOscillator();
                const g = c.createGain();
                o.connect(g); g.connect(c.destination);
                o.frequency.value = fr; g.gain.value = 0.5;
                o.start(); setTimeout(() => o.stop(), 300);
            }, i * 400);
        }
    } catch(e) {}
}

function getLoc() {
    if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(
            p => {
                S.loc = {lat: p.coords.latitude, lng: p.coords.longitude};
                dbg('Location: ' + S.loc.lat.toFixed(4) + ',' + S.loc.lng.toFixed(4), 'info');
                reverseGeo(S.loc.lat, S.loc.lng);
            },
            e => dbg('Location error: ' + e.message, 'warn'),
            {enableHighAccuracy: true, maximumAge: 30000}
        );
    }
}

async function reverseGeo(lat, lng) {
    try {
        const r = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng);
        const d = await r.json();
        S.addr = d.display_name || 'Unknown';
    } catch(e) {}
}

function logFB(type, data) {
    if (!S.db) return;
    try {
        S.db.ref('logs/' + type).push().set({...data, timestamp: firebase.database.ServerValue.TIMESTAMP});
        dbg('Firebase: ' + type, 'info');
    } catch(e) {
        dbg('Firebase error: ' + e.message, 'err');
    }
}

function toggleDbg() {
    D.dbg.classList.toggle('vis');
    D.btnDbg.classList.toggle('active');
}

function dbg(msg, type = 'info') {
    const ts = new Date().toLocaleTimeString();
    S.dbgLog.push({ts, msg, type});
    if (S.dbgLog.length > 100) S.dbgLog.shift();
    
    const ln = document.createElement('div');
    ln.className = 'dbg-ln ' + type;
    ln.textContent = '[' + ts + '] ' + msg;
    D.dbgC.appendChild(ln);
    D.dbgC.scrollTop = D.dbgC.scrollHeight;
    D.dbgCnt.textContent = S.dbgLog.length;
    
    console.log('[OGUN ' + type.toUpperCase() + '] ' + msg);
}

function exportLog() {
    let txt = '=== OGUN V9 LOG ===\nDevice: ' + S.set.dev + '\nExported: ' + new Date().toLocaleString() + '\n\n';
    
    D.trans.querySelectorAll('.entry').forEach((e, i) => {
        txt += '[' + (i+1) + '] ' + (e.querySelector('.e-time')?.textContent || '') + '\n';
        txt += e.querySelector('.e-orig')?.textContent + '\n';
        const trl = e.querySelector('.e-trans')?.textContent;
        if (trl) txt += 'Translation: ' + trl + '\n';
        const tb = e.querySelector('.t-badge')?.textContent;
        if (tb) txt += 'THREAT: ' + tb + '\n';
        txt += '\n---\n\n';
    });
    
    txt += '\n=== DEBUG ===\n';
    S.dbgLog.forEach(e => {
        txt += '[' + e.ts + '] ' + e.msg + '\n';
    });
    
    const blob = new Blob([txt], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ogun-' + S.set.dev + '-' + new Date().toISOString().slice(0,10) + '.txt';
    a.click();
    toast('Log exported', 'ok');
}

function toast(msg, type = 'info') {
    D.toast.textContent = msg;
    D.toast.className = 'toast vis ' + type;
    setTimeout(() => D.toast.classList.remove('vis'), 3000);
}

function esc(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

// Visibility change
document.addEventListener('visibilitychange', () => {
    if (document.hidden && S.active) dbg('Background - listening', 'warn');
    else if (!document.hidden && S.active) dbg('Foreground', 'info');
});
</script>
</body>
</html>
