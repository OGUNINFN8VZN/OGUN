<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>OGUN V9 GODMODE</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #0a0a0f;
            --bg2: #111118;
            --bg3: #1a1a24;
            --bg4: #22222e;
            --border: #2a2a3a;
            --border2: #3a3a4a;
            --text: #ffffff;
            --text2: #b0b0c0;
            --text3: #707080;
            --accent: #e94560;
            --accent2: #c73850;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --critical: #ff0040;
            --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --mono: 'SF Mono', Monaco, Consolas, monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font); font-size: 14px; color: var(--text); background: var(--bg); -webkit-font-smoothing: antialiased; }
        button { font-family: inherit; cursor: pointer; border: none; outline: none; }
        input, select { font-family: inherit; outline: none; }

        .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 8px; }
        .logo-icon { font-size: 26px; }
        .logo-text { font-family: var(--mono); font-size: 20px; font-weight: 700; color: var(--accent); letter-spacing: 3px; }
        .logo-ver { font-family: var(--mono); font-size: 9px; color: var(--text3); background: var(--bg3); padding: 2px 6px; border-radius: 4px; margin-left: 4px; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .status { display: flex; align-items: center; gap: 8px; padding: 8px 14px; border-radius: 20px; font-family: var(--mono); font-size: 11px; font-weight: 600; }
        .status.standby { background: var(--bg3); color: var(--text3); border: 1px solid var(--border); }
        .status.active { background: rgba(16,185,129,0.15); color: var(--success); border: 1px solid var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { box-shadow: 0 0 15px rgba(16,185,129,0.3); } 50% { box-shadow: 0 0 25px rgba(16,185,129,0.5); } }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .btn-icon { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: var(--bg3); border: 1px solid var(--border); border-radius: 10px; font-size: 18px; }

        /* Debug */
        .debug-toggle { position: fixed; top: 58px; right: 12px; background: #2a1515; color: #ff6b6b; border: 1px solid #3a2020; padding: 6px 10px; border-radius: 6px; font-family: var(--mono); font-size: 10px; font-weight: 600; z-index: 150; }
        .debug-panel { display: none; background: #0d0a0a; border-bottom: 1px solid #3a1a1a; max-height: 200px; overflow-y: auto; font-family: var(--mono); font-size: 11px; }
        .debug-panel.visible { display: block; }
        .debug-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #1a0d0d; border-bottom: 1px solid #2a1515; position: sticky; top: 0; }
        .debug-title { color: #ff6b6b; font-weight: 600; }
        .debug-clear { background: #2a1515; color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-size: 10px; }
        .debug-content { padding: 8px 12px; }
        .debug-entry { padding: 3px 0; border-bottom: 1px solid #1a1212; word-break: break-all; color: #888; }
        .debug-entry.error { color: #ff6b6b; }
        .debug-entry.success { color: #4ade80; }
        .debug-entry.warning { color: #fbbf24; }
        .debug-entry.info { color: #60a5fa; }

        /* Main */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .transcript { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }

        /* Empty State */
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
        .empty-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .empty-title { font-family: var(--mono); font-size: 20px; font-weight: 600; color: var(--text2); margin-bottom: 10px; letter-spacing: 2px; }
        .empty-desc { font-size: 14px; color: var(--text3); max-width: 280px; margin-bottom: 16px; }
        .empty-hint { padding: 12px 16px; background: var(--bg3); border: 1px solid var(--border); border-radius: 10px; font-size: 12px; color: var(--text3); }
        .empty-hint strong { color: var(--accent); }

        /* Entry */
        .entry { background: var(--bg2); border-radius: 14px; padding: 14px 16px; border-left: 4px solid var(--border); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .entry.threat-low { border-left-color: var(--success); }
        .entry.threat-medium { border-left-color: var(--warning); background: linear-gradient(135deg, var(--bg2) 0%, rgba(245,158,11,0.08) 100%); }
        .entry.threat-high { border-left-color: var(--danger); background: linear-gradient(135deg, var(--bg2) 0%, rgba(239,68,68,0.12) 100%); }
        .entry.threat-critical { border-left-color: var(--critical); background: linear-gradient(135deg, var(--bg2) 0%, rgba(255,0,64,0.15) 100%); animation: slideIn 0.3s ease, criticalPulse 1.5s infinite; }
        @keyframes criticalPulse { 0%,100% { box-shadow: 0 0 0 0 rgba(255,0,64,0); } 50% { box-shadow: 0 0 20px 5px rgba(255,0,64,0.2); } }
        .entry-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .entry-time { font-family: var(--mono); font-size: 10px; color: var(--text3); }
        .entry-lang { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--accent); font-weight: 500; }
        .entry-source { font-family: var(--mono); font-size: 9px; color: var(--text3); background: var(--bg3); padding: 2px 8px; border-radius: 4px; }
        .entry-badge { margin-left: auto; padding: 4px 10px; border-radius: 6px; font-family: var(--mono); font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .entry-badge.low { background: var(--success); color: #fff; }
        .entry-badge.medium { background: var(--warning); color: #000; }
        .entry-badge.high { background: var(--danger); color: #fff; }
        .entry-badge.critical { background: var(--critical); color: #fff; animation: badgePulse 0.5s infinite; }
        @keyframes badgePulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        .entry-original { font-size: 14px; color: var(--warning); margin-bottom: 8px; padding: 10px 12px; background: var(--bg3); border-radius: 6px; border-left: 3px solid var(--warning); }
        .entry-original-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .entry-translation { font-size: 15px; color: var(--text); line-height: 1.5; }
        .entry-translation-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; margin-top: 8px; }
        .entry-threat { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .entry-threat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .entry-threat-cat { font-size: 12px; font-weight: 600; color: var(--accent); }
        .entry-threat-conf { font-size: 10px; color: var(--text3); }
        .entry-threat-pattern { font-family: var(--mono); font-size: 11px; color: var(--text3); }

        /* Processing */
        .processing { display: none; align-items: center; justify-content: center; gap: 12px; padding: 14px 16px; background: var(--bg2); border-top: 1px solid var(--border); }
        .processing.active { display: flex; }
        .processing-spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-text { font-size: 13px; color: var(--text2); }

        /* Controls */
        .controls { padding: 16px; background: var(--bg2); border-top: 1px solid var(--border); flex-shrink: 0; }
        .btn-activate { width: 100%; padding: 18px 24px; border-radius: 14px; font-family: var(--mono); font-size: 15px; font-weight: 700; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; gap: 12px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%); color: #fff; box-shadow: 0 4px 20px rgba(233,69,96,0.3); }
        .btn-activate.hidden { display: none; }
        .active-controls { display: none; gap: 12px; }
        .active-controls.visible { display: flex; }
        .btn-panic { background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%); color: #fff; border-radius: 14px; padding: 16px 20px; font-family: var(--mono); font-size: 11px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 80px; }
        .btn-panic-icon { font-size: 24px; }
        .btn-deactivate { flex: 1; background: var(--bg3); color: var(--text2); border: 1px solid var(--border); border-radius: 14px; padding: 16px 24px; font-family: var(--mono); font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Alert Overlay */
        .alert-overlay { display: none; position: fixed; inset: 0; z-index: 1000; flex-direction: column; background: var(--bg); overflow-y: auto; }
        .alert-overlay.visible { display: flex; }
        .alert-header { padding: 24px 20px; text-align: center; }
        .alert-header.critical { background: linear-gradient(135deg, var(--critical) 0%, #b30000 100%); animation: alertFlash 0.8s infinite; }
        .alert-header.high { background: linear-gradient(135deg, var(--danger) 0%, #991b1b 100%); }
        .alert-header.medium { background: linear-gradient(135deg, var(--warning) 0%, #b45309 100%); }
        .alert-header.low { background: linear-gradient(135deg, var(--success) 0%, #047857 100%); }
        @keyframes alertFlash { 0%,100% { opacity: 1; } 50% { opacity: 0.85; } }
        .alert-icon { font-size: 48px; margin-bottom: 10px; }
        .alert-level { font-family: var(--mono); font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 3px; }
        .alert-category { font-size: 16px; color: rgba(255,255,255,0.9); margin-top: 6px; }
        .alert-time { font-family: var(--mono); font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 8px; }
        .alert-content { flex: 1; padding: 20px; }
        .alert-section { margin-bottom: 20px; }
        .alert-section-title { font-size: 11px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .alert-box { background: var(--bg2); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
        .alert-transcript { font-size: 15px; line-height: 1.6; color: var(--text); border-left: 3px solid var(--danger); padding-left: 14px; }
        .alert-coords { font-family: var(--mono); font-size: 16px; font-weight: 600; color: var(--success); margin-bottom: 6px; }
        .alert-address { font-size: 13px; color: var(--text2); margin-bottom: 12px; line-height: 1.4; }
        .alert-map { width: 100%; height: 180px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 12px; background: var(--bg3); }
        .btn-directions { width: 100%; padding: 12px; background: var(--success); color: #fff; border-radius: 10px; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .alert-details { display: flex; flex-direction: column; }
        .alert-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .alert-row:last-child { border-bottom: none; }
        .alert-label { font-size: 13px; color: var(--text3); }
        .alert-value { font-size: 13px; color: var(--text); font-weight: 500; }
        .alert-actions { display: flex; gap: 12px; padding: 20px; background: var(--bg2); border-top: 1px solid var(--border); }
        .btn-dismiss { flex: 1; padding: 16px; background: var(--bg3); color: var(--text2); border: 1px solid var(--border); border-radius: 14px; font-size: 14px; font-weight: 600; }
        .btn-escalate { flex: 1; padding: 16px; background: var(--danger); color: #fff; border-radius: 14px; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* Settings Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 500; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.visible { display: flex; }
        .modal { width: 100%; max-width: 400px; max-height: 85vh; background: var(--bg2); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg3); border-radius: 8px; font-size: 18px; color: var(--text3); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-section { margin-bottom: 24px; }
        .settings-section:last-child { margin-bottom: 0; }
        .settings-title { font-size: 11px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; }
        .settings-group { background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border); }
        .settings-row:last-child { border-bottom: none; }
        .settings-label { font-size: 13px; color: var(--text); }
        .settings-value { font-size: 12px; color: var(--text3); display: flex; align-items: center; gap: 6px; }
        .settings-dot { width: 8px; height: 8px; border-radius: 50%; }
        .settings-dot.ok { background: var(--success); }
        .settings-dot.pending { background: var(--warning); }
        .settings-dot.error { background: var(--danger); }
        .settings-input-row { padding: 14px 16px; border-bottom: 1px solid var(--border); }
        .settings-input-row:last-child { border-bottom: none; }
        .settings-input-label { font-size: 12px; color: var(--text3); margin-bottom: 8px; display: block; }
        .settings-input { width: 100%; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-family: var(--mono); font-size: 12px; color: var(--text); }
        .settings-input:focus { border-color: var(--accent); }
        .settings-select { width: 100%; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-size: 13px; color: var(--text); }
        .settings-btn { width: 100%; padding: 12px; margin-top: 12px; background: var(--accent); color: #fff; border-radius: 10px; font-size: 13px; font-weight: 600; }
        .settings-info { font-size: 12px; color: var(--text2); padding: 14px 16px; line-height: 1.6; }
        .settings-duress { font-family: var(--mono); font-size: 14px; color: var(--accent); padding: 14px 16px; }

        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg3); color: var(--text); padding: 14px 24px; border-radius: 12px; font-size: 13px; font-weight: 500; opacity: 0; transition: all 0.3s ease; z-index: 1100; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); }
        .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #14532d; border-color: var(--success); }
        .toast.error { background: #7f1d1d; border-color: var(--danger); }
        .toast.warning { background: #78350f; border-color: var(--warning); }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">
                <span class="logo-icon">‚öîÔ∏è</span>
                <span class="logo-text">OGUN</span>
                <span class="logo-ver">V9</span>
            </div>
            <div class="header-right">
                <div class="status standby" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">STANDBY</span>
                </div>
                <button class="btn-icon" id="btnSettings">‚öôÔ∏è</button>
            </div>
        </header>

        <button class="debug-toggle" id="debugToggle">üêõ DEBUG</button>

        <div class="debug-panel" id="debugPanel">
            <div class="debug-header">
                <span class="debug-title">Debug Console</span>
                <button class="debug-clear" id="debugClear">Clear</button>
            </div>
            <div class="debug-content" id="debugContent"></div>
        </div>

        <main class="main">
            <div class="transcript" id="transcript">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">‚öîÔ∏è</div>
                    <div class="empty-title">OGUN READY</div>
                    <div class="empty-desc">Real-time Ghanaian language transcription + translation + threat detection</div>
                    <div class="empty-hint"><strong>First time?</strong> Tap ‚öôÔ∏è to configure</div>
                </div>
            </div>

            <div class="processing" id="processing">
                <div class="processing-spinner"></div>
                <span class="processing-text" id="processingText">Processing audio...</span>
            </div>
        </main>

        <div class="controls">
            <button class="btn-activate" id="btnActivate">
                <span>‚öîÔ∏è</span>
                <span>ACTIVATE OGUN</span>
            </button>
            <div class="active-controls" id="activeControls">
                <button class="btn-panic" id="btnPanic">
                    <span class="btn-panic-icon">üÜò</span>
                    <span>PANIC</span>
                </button>
                <button class="btn-deactivate" id="btnDeactivate">
                    <span>‚ñ†</span>
                    <span>DEACTIVATE</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Overlay -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-header critical" id="alertHeader">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div class="alert-level" id="alertLevel">CRITICAL THREAT</div>
            <div class="alert-category" id="alertCategory">Category</div>
            <div class="alert-time" id="alertTime">--:--:--</div>
        </div>
        <div class="alert-content">
            <div class="alert-section">
                <div class="alert-section-title">üìù Intercepted Speech</div>
                <div class="alert-box">
                    <div class="alert-transcript" id="alertTranscript">‚Äî</div>
                </div>
            </div>
            <div class="alert-section">
                <div class="alert-section-title">üìç Location</div>
                <div class="alert-box">
                    <div class="alert-coords" id="alertCoords">Acquiring GPS...</div>
                    <div class="alert-address" id="alertAddress">Resolving address...</div>
                    <iframe id="alertMap" class="alert-map" frameborder="0" loading="lazy"></iframe>
                    <button class="btn-directions" id="btnDirections">üß≠ GET DIRECTIONS</button>
                </div>
            </div>
            <div class="alert-section">
                <div class="alert-section-title">‚ÑπÔ∏è Details</div>
                <div class="alert-box alert-details">
                    <div class="alert-row">
                        <span class="alert-label">Confidence</span>
                        <span class="alert-value" id="alertConfidence">‚Äî</span>
                    </div>
                    <div class="alert-row">
                        <span class="alert-label">Pattern Matched</span>
                        <span class="alert-value" id="alertPattern">‚Äî</span>
                    </div>
                    <div class="alert-row">
                        <span class="alert-label">Device</span>
                        <span class="alert-value" id="alertDevice">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="alert-actions">
            <button class="btn-dismiss" id="btnDismiss">DISMISS</button>
            <button class="btn-escalate" id="btnEscalate">üìû CALL SECURITY</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Settings</span>
                <button class="modal-close" id="btnCloseSettings">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-title">Language Mode</div>
                    <div class="settings-group">
                        <div class="settings-input-row">
                            <label class="settings-input-label">Source Language</label>
                            <select class="settings-select" id="selectLanguage">
                                <option value="tw">üá¨üá≠ Twi</option>
                                <option value="ee">üá¨üá≠ Ewe</option>
                                <option value="gaa">üá¨üá≠ Ga</option>
                                <option value="dag">üá¨üá≠ Dagbani</option>
                                <option value="fat">üá¨üá≠ Fante</option>
                                <option value="ak">üá¨üá≠ Akan</option>
                                <option value="yo">üá≥üá¨ Yoruba</option>
                                <option value="ha">üá≥üá¨ Hausa</option>
                                <option value="en" selected>üåç English (Groq)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">API Keys</div>
                    <div class="settings-group">
                        <div class="settings-input-row">
                            <label class="settings-input-label">GhanaNLP Key (ASR + Translation)</label>
                            <input type="password" class="settings-input" id="inputGhanaNlpKey" placeholder="Enter GhanaNLP key...">
                        </div>
                        <div class="settings-input-row">
                            <label class="settings-input-label">Groq Key (English fallback)</label>
                            <input type="password" class="settings-input" id="inputGroqKey" placeholder="gsk_...">
                        </div>
                        <div class="settings-input-row">
                            <button class="settings-btn" id="btnSaveKeys">Save API Keys</button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Status</div>
                    <div class="settings-group">
                        <div class="settings-row">
                            <span class="settings-label">GhanaNLP (ASR + Translate)</span>
                            <span class="settings-value"><span class="settings-dot pending" id="dotGhanaNlp"></span><span id="txtGhanaNlp">Not set</span></span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Groq (English)</span>
                            <span class="settings-value"><span class="settings-dot pending" id="dotGroq"></span><span id="txtGroq">Not set</span></span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Firebase</span>
                            <span class="settings-value"><span class="settings-dot pending" id="dotFirebase"></span><span id="txtFirebase">Connecting...</span></span>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Team</div>
                    <div class="settings-group">
                        <div class="settings-input-row">
                            <label class="settings-input-label">Security Phone</label>
                            <input type="tel" class="settings-input" id="inputSecurityPhone" placeholder="+233...">
                        </div>
                        <div class="settings-input-row">
                            <label class="settings-input-label">Device Name</label>
                            <input type="text" class="settings-input" id="inputDeviceName" placeholder="Alpha-1">
                        </div>
                        <div class="settings-input-row">
                            <button class="settings-btn" id="btnSaveTeam">Save Team Settings</button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Duress Code</div>
                    <div class="settings-group">
                        <div class="settings-duress">"Call my mom" ‚Äî triggers silent CRITICAL alert</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toastMsg"></span></div>

<script>
(function() {
    "use strict";

    var CONFIG = {
        GHANANLP_ASR_URL: "https://asr.ghananlp.org/asr/v1/transcribe",
        GHANANLP_TRANSLATE_URL: "https://translation-api.ghananlp.org/v1/translate",
        GROQ_URL: "https://api.groq.com/openai/v1/audio/transcriptions",
        GROQ_MODEL: "whisper-large-v3",
        AUDIO_CHUNK_MS: 5000,
        FIREBASE: {
            apiKey: "AIzaSyAiI07Y2Erzo7TIOoyOiXpiZIk7HoUyn8c",
            authDomain: "ogun-guardian-v1.firebaseapp.com",
            projectId: "ogun-guardian-v1",
            storageBucket: "ogun-guardian-v1.firebasestorage.app",
            messagingSenderId: "875607675728",
            appId: "1:875607675728:web:e52603a7ae927a58ead255",
            databaseURL: "https://ogun-guardian-v1-default-rtdb.europe-west1.firebasedatabase.app"
        },
        STORAGE: {
            GHANANLP: "ogun_ghananlp_key",
            GROQ: "ogun_groq_key",
            PHONE: "ogun_security_phone",
            DEVICE: "ogun_device_name",
            LANGUAGE: "ogun_language"
        },
        DURESS_CODES: ["call my mom", "call my mum", "call my mother", "phone my mom", "i need to call home", "fr…õ me maame", "fr…õ maame"],
        LANGUAGES: {
            "tw": { name: "Twi", flag: "üá¨üá≠", asr: true },
            "ak": { name: "Akan", flag: "üá¨üá≠", asr: true },
            "ee": { name: "Ewe", flag: "üá¨üá≠", asr: true },
            "gaa": { name: "Ga", flag: "üá¨üá≠", asr: true },
            "dag": { name: "Dagbani", flag: "üá¨üá≠", asr: true },
            "fat": { name: "Fante", flag: "üá¨üá≠", asr: true },
            "yo": { name: "Yoruba", flag: "üá≥üá¨", asr: true },
            "ha": { name: "Hausa", flag: "üá≥üá¨", asr: true },
            "en": { name: "English", flag: "üåç", asr: false }
        }
    };

    var THREATS = {
        critical: [
            { p: /\b(kill|murder|shoot|execute)\s*(them|him|her|the|those)/i, c: "VIOLENCE - LETHAL INTENT", w: 95 },
            { p: /\bkum\s*(won|no|w…în)/i, c: "TWI - KILL THEM", w: 96 },
            { p: /\b(stab|slash|cut)\s*(them|him|her|his|throat)/i, c: "VIOLENCE - BLADE ATTACK", w: 95 },
            { p: /\battack\s*(them|him|her|the|now)/i, c: "VIOLENCE - ATTACK ORDER", w: 92 },
            { p: /\bto\s*(won|w…în)/i, c: "TWI - ATTACK THEM", w: 93 },
            { p: /\b(gun|pistol|rifle|ak|weapon)\b/i, c: "WEAPON - FIREARM", w: 94 },
            { p: /\btuo\b/i, c: "TWI - GUN", w: 94 },
            { p: /\b(knife|cutlass|machete|blade|axe)\b/i, c: "WEAPON - BLADE", w: 90 },
            { p: /\bsekan\b/i, c: "TWI - KNIFE", w: 91 },
            { p: /\bambush\b/i, c: "TACTICAL - AMBUSH", w: 93 },
            { p: /\btrap\s*(them|him|her)/i, c: "TACTICAL - TRAP", w: 91 },
            { p: /\bsurround\s*(them|the)/i, c: "TACTICAL - SURROUND", w: 90 },
            { p: /\bblock\s*(the\s*)?(road|path|exit)/i, c: "TACTICAL - BLOCK ESCAPE", w: 92 },
            { p: /\bno\s*witness/i, c: "ELIMINATION - NO WITNESS", w: 96 },
            { p: /\bleave\s*no\s*trace/i, c: "ELIMINATION - COVER UP", w: 94 },
            { p: /\b(bury|dump)\s*(the\s*)?(body|bodies|them)/i, c: "ELIMINATION - BODY DISPOSAL", w: 97 },
            { p: /\b(grab|snatch|kidnap|abduct)\s*(them|him|her)/i, c: "KIDNAPPING", w: 95 },
            { p: /\bkyere\s*(won|no|w…în)/i, c: "TWI - CAPTURE THEM", w: 94 },
            { p: /\btie\s*(them|him|her)\s*up/i, c: "KIDNAPPING - RESTRAINT", w: 93 },
            { p: /\bfinish\s*(them|him|her|it)\s*(off)?/i, c: "VIOLENCE - FINISH OFF", w: 94 },
            { p: /\bhurt\s*(them|him|her)\s*(bad|badly)?/i, c: "VIOLENCE - HARM", w: 88 },
            { p: /\bbeat\s*(them|him|her)\b/i, c: "VIOLENCE - ASSAULT", w: 87 },
            { p: /\bboro\s*(won|no|w…în)/i, c: "TWI - BEAT THEM", w: 88 }
        ],
        high: [
            { p: /\bfollow\s*(them|him|her|the)/i, c: "SURVEILLANCE - FOLLOWING", w: 82 },
            { p: /\bdi\s*(won|w…în)\s*akyi/i, c: "TWI - FOLLOW THEM", w: 83 },
            { p: /\btrack\s*(them|him|her|the)/i, c: "SURVEILLANCE - TRACKING", w: 82 },
            { p: /\bwatch\s*(them|him|her|the|where)/i, c: "SURVEILLANCE - WATCHING", w: 78 },
            { p: /\bhw…õ\s*(won|w…în)/i, c: "TWI - WATCH THEM", w: 80 },
            { p: /\bmonitor\s*(them|their|the)/i, c: "SURVEILLANCE - MONITORING", w: 77 },
            { p: /\bspy\s*(on)?\s*(them|him|her)/i, c: "SURVEILLANCE - SPYING", w: 80 },
            { p: /\bwhere\s*(do\s*)?(they|he|she)\s*(stay|live|sleep)/i, c: "INTEL - LOCATION PROBE", w: 83 },
            { p: /\behe\s*na\s*(wo|w…î)\s*te/i, c: "TWI - WHERE DO THEY LIVE", w: 84 },
            { p: /\bwhere\s*(is\s*)?(their|the)\s*(camp|base|house)/i, c: "INTEL - BASE LOCATION", w: 84 },
            { p: /\bsteal\s*(the\s*)?(gold|equipment|money|vehicle)/i, c: "THEFT - PLANNING", w: 85 },
            { p: /\bwia\b/i, c: "TWI - STEAL", w: 86 },
            { p: /\brob\s*(them|the)/i, c: "THEFT - ROBBERY", w: 86 },
            { p: /\btake\s*(their|the)\s*(gold|equipment|stuff|things)/i, c: "THEFT - ASSET SEIZURE", w: 83 },
            { p: /\bfa\s*(won|w…în)\s*(sika|ade)/i, c: "TWI - TAKE THEIR THINGS", w: 84 },
            { p: /\bseize\s*(the\s*)?(machine|equipment|vehicle)/i, c: "THEFT - SEIZURE", w: 82 },
            { p: /\bcall\s*(the\s*)?(boys|guys|men|others)/i, c: "REINFORCEMENT - CALLING BACKUP", w: 84 },
            { p: /\bfr…õ\s*(mmarima|nkur…îfo)/i, c: "TWI - CALL THE MEN", w: 85 },
            { p: /\bget\s*(the\s*)?(others|boys|men|crew)/i, c: "REINFORCEMENT - GATHERING", w: 82 },
            { p: /\bbring\s*(more\s*)?(men|boys|people)/i, c: "REINFORCEMENT - BRINGING MORE", w: 83 },
            { p: /\btonight\b/i, c: "TIMING - NIGHT OP", w: 75 },
            { p: /\bnn…õ\s*anadwo/i, c: "TWI - TONIGHT", w: 77 },
            { p: /\bafter\s*dark/i, c: "TIMING - AFTER DARK", w: 77 },
            { p: /\bwhen\s*(they\s*)?(sleep|sleeping)/i, c: "TIMING - SLEEP ATTACK", w: 80 },
            { p: /\bearly\s*morning/i, c: "TIMING - DAWN RAID", w: 74 },
            { p: /\b(foreigners?|strangers?|outsiders?)\b/i, c: "TARGETING - OUTSIDERS", w: 72 },
            { p: /\bah…îho/i, c: "TWI - STRANGERS", w: 74 },
            { p: /\bwhite\s*(man|men|people|woman)/i, c: "TARGETING - RACIAL", w: 78 },
            { p: /\b(obroni|oburoni)\b/i, c: "TWI - WHITE PERSON", w: 76 },
            { p: /\bthe\s*ngo\s*(people|guys|team)/i, c: "TARGETING - NGO TEAM", w: 85 },
            { p: /\bbribe\s*(the\s*)?(police|chief|officer)/i, c: "CORRUPTION - BRIBERY", w: 80 },
            { p: /\bpay\s*(off|them)\s*(the\s*)?(police|chief)?/i, c: "CORRUPTION - PAYOFF", w: 78 },
            { p: /\bi\s*know\s*(someone|people|a\s*guy)/i, c: "CORRUPTION - CONNECTIONS", w: 70 }
        ],
        medium: [
            { p: /\bhow\s*many\s*(of\s*)?(them|guards|people|are)/i, c: "INTEL - NUMBER PROBE", w: 68 },
            { p: /\bwho\s*(is\s*)?(guarding|watching|protecting)/i, c: "INTEL - SECURITY PROBE", w: 70 },
            { p: /\bwhen\s*(do\s*)?(they|he|she)\s*(leave|go|come)/i, c: "INTEL - SCHEDULE PROBE", w: 67 },
            { p: /\bwhat\s*time\b/i, c: "INTEL - TIMING PROBE", w: 60 },
            { p: /\btheir\s*(schedule|routine)/i, c: "INTEL - ROUTINE PROBE", w: 68 },
            { p: /\b(their|the)\s*(gold|equipment|machines?|vehicles?)/i, c: "ASSET - INTEREST", w: 62 },
            { p: /\bsika\s*k…îk…î…î/i, c: "TWI - GOLD", w: 65 },
            { p: /\bgps\s*(tracker|tracking|device)/i, c: "ASSET - GPS INTEREST", w: 72 },
            { p: /\bgalamsey\b/i, c: "CONTEXT - GALAMSEY", w: 55 },
            { p: /\billegal\s*mining/i, c: "CONTEXT - ILLEGAL MINING", w: 58 },
            { p: /\bour\s*(pit|site|land|area)/i, c: "TERRITORY - CLAIM", w: 60 },
            { p: /\bchanfan\b/i, c: "CONTEXT - CHANFAN", w: 65 },
            { p: /\bdon'?t\s*tell\s*(anyone|anybody|them)/i, c: "SECRECY - CONCEALMENT", w: 66 },
            { p: /\bnka\s*obiara/i, c: "TWI - DON'T TELL ANYONE", w: 68 },
            { p: /\bkeep\s*(it\s*)?(quiet|secret)/i, c: "SECRECY - QUIET", w: 64 },
            { p: /\bsecret(ly)?\b/i, c: "SECRECY - SECRET", w: 58 },
            { p: /\bhidden\b/i, c: "SECRECY - HIDDEN", w: 55 },
            { p: /\bquietly\b/i, c: "SECRECY - QUIETLY", w: 52 },
            { p: /\beasy\s*target/i, c: "VULNERABILITY - EASY TARGET", w: 75 },
            { p: /\bnot?\s*(protected|guarded)/i, c: "VULNERABILITY - UNPROTECTED", w: 72 },
            { p: /\b(alone|by\s*(himself|herself|themselves))/i, c: "VULNERABILITY - ISOLATED", w: 68 },
            { p: /\bno\s*(security|guards?|protection)/i, c: "VULNERABILITY - NO SECURITY", w: 74 },
            { p: /\bunguarded\b/i, c: "VULNERABILITY - UNGUARDED", w: 70 },
            { p: /\bthis\s*is\s*our\s*(land|territory|area)/i, c: "TERRITORY - CLAIM", w: 65 },
            { p: /\bwe\s*(were|was)\s*here\s*first/i, c: "TERRITORY - PRECEDENCE", w: 62 },
            { p: /\bthey\s*don'?t\s*belong/i, c: "TERRITORY - REJECTION", w: 66 },
            { p: /\bgo\s*back\s*(where|to)/i, c: "TERRITORY - EXPULSION", w: 64 }
        ],
        low: [
            { p: /\bstranger\b/i, c: "SUSPICION - STRANGER", w: 40 },
            { p: /\bsuspicious\b/i, c: "SUSPICION - SUSPICIOUS", w: 45 },
            { p: /\bunusual\b/i, c: "SUSPICION - UNUSUAL", w: 38 },
            { p: /\bwatching\s*us/i, c: "SUSPICION - BEING WATCHED", w: 50 },
            { p: /\bbe\s*careful/i, c: "CAUTION - BE CAREFUL", w: 42 },
            { p: /\bwatch\s*out/i, c: "CAUTION - WATCH OUT", w: 44 },
            { p: /\bsomething\s*(is\s*)?(wrong|off)/i, c: "CAUTION - SOMETHING WRONG", w: 48 },
            { p: /\bbad\s*feeling/i, c: "CAUTION - BAD FEELING", w: 46 },
            { p: /\bthey'?re\s*coming/i, c: "MOVEMENT - APPROACHING", w: 52 },
            { p: /\bapproaching\b/i, c: "MOVEMENT - APPROACHING", w: 50 },
            { p: /\bgetting\s*closer/i, c: "MOVEMENT - GETTING CLOSER", w: 54 },
            { p: /\bheading\s*(this\s*way|here|towards)/i, c: "MOVEMENT - HEADING HERE", w: 52 },
            { p: /\bwho\s*(are|is)\s*(they|he|she|that)/i, c: "IDENTIFICATION - WHO ARE THEY", w: 35 },
            { p: /\bwhat\s*(do\s*)?(they|he|she)\s*want/i, c: "IDENTIFICATION - WHAT DO THEY WANT", w: 38 },
            { p: /\bwhy\s*(are|is)\s*(they|he|she)\s*here/i, c: "IDENTIFICATION - WHY HERE", w: 40 }
        ]
    };

    var state = {
        active: false,
        processing: false,
        mediaRecorder: null,
        audioChunks: [],
        location: null,
        address: "",
        settings: {
            ghanaNlpKey: "",
            groqKey: "",
            securityPhone: "",
            deviceName: "OGUN-1",
            language: "en"
        }
    };

    var db = null;
    var DOM = {};

    function initDOM() {
        var ids = [
            "statusBadge", "statusText", "btnSettings", "debugToggle", "debugPanel",
            "debugContent", "debugClear", "transcript", "emptyState", "processing", "processingText",
            "btnActivate", "activeControls", "btnPanic", "btnDeactivate",
            "alertOverlay", "alertHeader", "alertLevel", "alertCategory", "alertTime",
            "alertTranscript", "alertCoords", "alertAddress", "alertMap", "btnDirections",
            "alertConfidence", "alertPattern", "alertDevice", "btnDismiss", "btnEscalate",
            "settingsModal", "btnCloseSettings", "selectLanguage", "inputGhanaNlpKey", "inputGroqKey",
            "btnSaveKeys", "dotGhanaNlp", "txtGhanaNlp", "dotGroq", "txtGroq",
            "dotFirebase", "txtFirebase", "inputSecurityPhone", "inputDeviceName", "btnSaveTeam",
            "toast", "toastMsg"
        ];
        for (var i = 0; i < ids.length; i++) {
            DOM[ids[i]] = document.getElementById(ids[i]);
        }
    }

    function log(msg, type) {
        type = type || "info";
        var ts = new Date().toLocaleTimeString();
        console.log("[OGUN " + type.toUpperCase() + "] " + msg);
        if (DOM.debugContent) {
            var entry = document.createElement("div");
            entry.className = "debug-entry " + type;
            entry.textContent = "[" + ts + "] " + msg;
            DOM.debugContent.appendChild(entry);
            DOM.debugContent.scrollTop = DOM.debugContent.scrollHeight;
        }
    }

    function toast(msg, type) {
        DOM.toastMsg.textContent = msg;
        DOM.toast.className = "toast visible " + (type || "");
        setTimeout(function() { DOM.toast.classList.remove("visible"); }, 3000);
    }

    function save(key, val) {
        try { localStorage.setItem(key, val); } catch (e) { log("Storage error: " + e.message, "error"); }
    }

    function load(key, def) {
        try { return localStorage.getItem(key) || def; } catch (e) { return def; }
    }

    function escapeHtml(text) {
        var div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    function loadSettings() {
        state.settings.ghanaNlpKey = load(CONFIG.STORAGE.GHANANLP, "");
        state.settings.groqKey = load(CONFIG.STORAGE.GROQ, "");
        state.settings.securityPhone = load(CONFIG.STORAGE.PHONE, "");
        state.settings.deviceName = load(CONFIG.STORAGE.DEVICE, "OGUN-1");
        state.settings.language = load(CONFIG.STORAGE.LANGUAGE, "en");

        DOM.inputGhanaNlpKey.value = state.settings.ghanaNlpKey;
        DOM.inputGroqKey.value = state.settings.groqKey;
        DOM.inputSecurityPhone.value = state.settings.securityPhone;
        DOM.inputDeviceName.value = state.settings.deviceName;
        DOM.selectLanguage.value = state.settings.language;

        updateStatusIndicators();
        log("Settings loaded", "success");
    }

    function updateStatusIndicators() {
        var hasGhanaNlp = state.settings.ghanaNlpKey.length > 10;
        var hasGroq = state.settings.groqKey.length > 10;

        DOM.dotGhanaNlp.className = "settings-dot " + (hasGhanaNlp ? "ok" : "pending");
        DOM.txtGhanaNlp.textContent = hasGhanaNlp ? "Ready" : "Not set";

        DOM.dotGroq.className = "settings-dot " + (hasGroq ? "ok" : "pending");
        DOM.txtGroq.textContent = hasGroq ? "Ready" : "Not set";

        DOM.dotFirebase.className = "settings-dot " + (db ? "ok" : "pending");
        DOM.txtFirebase.textContent = db ? "Connected" : "Connecting...";
    }

    function saveAPIKeys() {
        var ghananlp = DOM.inputGhanaNlpKey.value.trim();
        var groq = DOM.inputGroqKey.value.trim();

        if (ghananlp) {
            save(CONFIG.STORAGE.GHANANLP, ghananlp);
            state.settings.ghanaNlpKey = ghananlp;
        }
        if (groq) {
            save(CONFIG.STORAGE.GROQ, groq);
            state.settings.groqKey = groq;
        }

        updateStatusIndicators();
        toast("API keys saved", "success");
        log("API keys saved", "success");
    }

    function saveTeamSettings() {
        var phone = DOM.inputSecurityPhone.value.trim();
        var device = DOM.inputDeviceName.value.trim();
        var lang = DOM.selectLanguage.value;

        if (phone) { save(CONFIG.STORAGE.PHONE, phone); state.settings.securityPhone = phone; }
        if (device) { save(CONFIG.STORAGE.DEVICE, device); state.settings.deviceName = device; }
        save(CONFIG.STORAGE.LANGUAGE, lang);
        state.settings.language = lang;

        toast("Settings saved", "success");
        log("Language set to: " + CONFIG.LANGUAGES[lang].name, "success");
    }

    function initFirebase() {
        if (typeof firebase === "undefined") {
            setTimeout(initFirebase, 500);
            return;
        }
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(CONFIG.FIREBASE);
            }
            db = firebase.database();
            log("Firebase connected", "success");
            updateStatusIndicators();
        } catch (e) {
            log("Firebase error: " + e.message, "error");
        }
    }

    function syncToFirebase(original, translated, lang, threat) {
        if (!db) return;
        try {
            var data = {
                original: original,
                translated: translated,
                language: lang,
                languageName: CONFIG.LANGUAGES[lang] ? CONFIG.LANGUAGES[lang].name : lang,
                threat: threat,
                location: state.location,
                address: state.address,
                device: state.settings.deviceName,
                timestamp: Date.now(),
                timestampISO: new Date().toISOString()
            };
            db.ref("transcripts").push(data);
            if (threat && (threat.level === "critical" || threat.level === "high")) {
                db.ref("alerts").push(data);
            }
            log("Synced to Firebase", "success");
        } catch (e) {
            log("Firebase sync error: " + e.message, "error");
        }
    }

    function startAudioCapture() {
        var lang = state.settings.language;
        var useGhanaNLP = CONFIG.LANGUAGES[lang] && CONFIG.LANGUAGES[lang].asr;

        if (useGhanaNLP && !state.settings.ghanaNlpKey) {
            toast("Set GhanaNLP API key first", "error");
            DOM.settingsModal.classList.add("visible");
            return;
        }

        if (!useGhanaNLP && !state.settings.groqKey) {
            toast("Set Groq API key first", "error");
            DOM.settingsModal.classList.add("visible");
            return;
        }

        var constraints = {
            audio: {
                sampleRate: 16000,
                channelCount: 1,
                echoCancellation: true,
                noiseSuppression: true
            }
        };

        navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
            log("Microphone access granted", "success");

            var mimeType = "";
            if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
                mimeType = "audio/webm;codecs=opus";
            } else if (MediaRecorder.isTypeSupported("audio/webm")) {
                mimeType = "audio/webm";
            } else if (MediaRecorder.isTypeSupported("audio/mp4")) {
                mimeType = "audio/mp4";
            }

            var options = mimeType ? { mimeType: mimeType } : {};
            state.mediaRecorder = new MediaRecorder(stream, options);
            state.audioChunks = [];

            state.mediaRecorder.ondataavailable = function(e) {
                if (e.data && e.data.size > 0) {
                    state.audioChunks.push(e.data);
                }
            };

            state.mediaRecorder.onstop = function() {
                if (state.audioChunks.length > 0 && state.active) {
                    var blob = new Blob(state.audioChunks, { type: mimeType || "audio/webm" });
                    state.audioChunks = [];
                    if (blob.size > 1000) {
                        processAudio(blob);
                    }
                }
                if (state.active && state.mediaRecorder && state.mediaRecorder.state === "inactive") {
                    state.audioChunks = [];
                    try {
                        state.mediaRecorder.start();
                        setTimeout(function() {
                            if (state.mediaRecorder && state.mediaRecorder.state === "recording") {
                                state.mediaRecorder.stop();
                            }
                        }, CONFIG.AUDIO_CHUNK_MS);
                    } catch (e) {
                        log("Recording restart error: " + e.message, "error");
                    }
                }
            };

            state.mediaRecorder.onerror = function(e) {
                log("MediaRecorder error: " + e.error, "error");
            };

            state.mediaRecorder.start();
            log("Audio capture started (5s cycles) - Mode: " + CONFIG.LANGUAGES[lang].name, "success");

            setTimeout(function() {
                if (state.mediaRecorder && state.mediaRecorder.state === "recording") {
                    state.mediaRecorder.stop();
                }
            }, CONFIG.AUDIO_CHUNK_MS);
        })
        .catch(function(e) {
            log("Microphone error: " + e.message, "error");
            toast("Microphone access denied", "error");
            deactivate();
        });
    }

    function stopAudioCapture() {
        if (state.mediaRecorder) {
            try {
                if (state.mediaRecorder.state === "recording") {
                    state.mediaRecorder.stop();
                }
                state.mediaRecorder.stream.getTracks().forEach(function(track) {
                    track.stop();
                });
            } catch (e) {
                log("Stop audio error: " + e.message, "error");
            }
            state.mediaRecorder = null;
        }
        state.audioChunks = [];
    }

    function processAudio(blob) {
        if (state.processing) {
            log("Already processing, skipping", "warning");
            return;
        }

        state.processing = true;
        DOM.processing.classList.add("active");

        var lang = state.settings.language;
        var useGhanaNLP = CONFIG.LANGUAGES[lang] && CONFIG.LANGUAGES[lang].asr;

        log("Processing " + (blob.size / 1024).toFixed(1) + "KB - Mode: " + (useGhanaNLP ? "GhanaNLP ASR" : "Groq"));
        DOM.processingText.textContent = useGhanaNLP ? "Transcribing " + CONFIG.LANGUAGES[lang].name + "..." : "Processing English...";

        var transcribePromise;

        if (useGhanaNLP) {
            transcribePromise = transcribeWithGhanaNLP(blob, lang);
        } else {
            transcribePromise = transcribeWithGroq(blob);
        }

        transcribePromise
        .then(function(result) {
            if (!result || !result.text || result.text.trim().length < 2) {
                log("No speech detected");
                return null;
            }

            var original = result.text.trim();
            log("Transcribed (" + lang + "): " + original.substring(0, 80), "success");

            if (useGhanaNLP && lang !== "en") {
                DOM.processingText.textContent = "Translating to English...";
                return translateWithGhanaNLP(original, lang).then(function(translated) {
                    return {
                        original: original,
                        translated: translated || original,
                        lang: lang
                    };
                });
            }
            return { original: original, translated: original, lang: lang };
        })
        .then(function(data) {
            if (!data) return;

            if (data.translated && data.translated !== data.original) {
                log("Translated: " + data.translated.substring(0, 80), "success");
            }

            var threat = analyzeThreat(data.translated, data.original);
            addTranscriptEntry(data.original, data.translated, data.lang, threat);

            if (threat) {
                if (threat.level === "critical" || threat.level === "high") {
                    triggerAlert(threat, data.translated, data.original);
                } else if (threat.level === "medium") {
                    playAlertSound("medium");
                }
            }

            syncToFirebase(data.original, data.translated, data.lang, threat);
        })
        .catch(function(e) {
            log("Processing error: " + e.message, "error");
        })
        .finally(function() {
            state.processing = false;
            DOM.processing.classList.remove("active");
            DOM.processingText.textContent = "Processing audio...";
        });
    }

    function transcribeWithGhanaNLP(blob, lang) {
        log("Sending to GhanaNLP ASR (" + lang + ")...");

        return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onloadend = function() {
                var base64 = reader.result.split(",")[1];

                fetch(CONFIG.GHANANLP_ASR_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Ocp-Apim-Subscription-Key": state.settings.ghanaNlpKey
                    },
                    body: JSON.stringify({
                        audio: base64,
                        language: lang
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        return response.text().then(function(txt) {
                            throw new Error("GhanaNLP ASR " + response.status + ": " + txt.substring(0, 100));
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    log("GhanaNLP ASR response received", "success");
                    resolve({ text: data.transcript || data.text || "", language: lang });
                })
                .catch(function(e) {
                    log("GhanaNLP ASR error: " + e.message, "error");
                    resolve(null);
                });
            };
            reader.onerror = function() {
                reject(new Error("Failed to read audio blob"));
            };
            reader.readAsDataURL(blob);
        });
    }

    function transcribeWithGroq(blob) {
        var formData = new FormData();
        formData.append("file", blob, "audio.webm");
        formData.append("model", CONFIG.GROQ_MODEL);
        formData.append("response_format", "verbose_json");

        return fetch(CONFIG.GROQ_URL, {
            method: "POST",
            headers: { "Authorization": "Bearer " + state.settings.groqKey },
            body: formData
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error("Groq API " + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            return { text: data.text || "", language: "en" };
        })
        .catch(function(e) {
            log("Groq error: " + e.message, "error");
            return null;
        });
    }

    function translateWithGhanaNLP(text, fromLang) {
        if (!state.settings.ghanaNlpKey) {
            return Promise.resolve(null);
        }

        var langPair = fromLang + "-en";
        log("Translating " + fromLang + " to English...");

        return fetch(CONFIG.GHANANLP_TRANSLATE_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Ocp-Apim-Subscription-Key": state.settings.ghanaNlpKey
            },
            body: JSON.stringify({ in: text, lang: langPair })
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error("GhanaNLP Translate " + response.status);
            }
            return response.text();
        })
        .then(function(result) {
            return result.trim();
        })
        .catch(function(e) {
            log("Translation error: " + e.message, "error");
            return null;
        });
    }

    function analyzeThreat(translated, original) {
        var text = (translated + " " + original).toLowerCase();

        for (var i = 0; i < CONFIG.DURESS_CODES.length; i++) {
            if (text.indexOf(CONFIG.DURESS_CODES[i]) !== -1) {
                log("üö® DURESS CODE: " + CONFIG.DURESS_CODES[i], "error");
                return { level: "critical", category: "DURESS CODE ACTIVATED", pattern: CONFIG.DURESS_CODES[i], confidence: 100 };
            }
        }

        var levels = ["critical", "high", "medium", "low"];
        for (var l = 0; l < levels.length; l++) {
            var level = levels[l];
            var patterns = THREATS[level];
            for (var p = 0; p < patterns.length; p++) {
                var match = text.match(patterns[p].p);
                if (match) {
                    var confidence = Math.min(patterns[p].w + Math.floor(Math.random() * 8), 100);
                    log("‚ö†Ô∏è THREAT [" + level.toUpperCase() + "]: " + patterns[p].c, level === "critical" || level === "high" ? "error" : "warning");
                    return { level: level, category: patterns[p].c, pattern: match[0], confidence: confidence };
                }
            }
        }
        return null;
    }

    function addTranscriptEntry(original, translated, lang, threat) {
        if (DOM.emptyState && DOM.emptyState.parentNode) {
            DOM.emptyState.parentNode.removeChild(DOM.emptyState);
        }

        var entry = document.createElement("div");
        entry.className = "entry" + (threat ? " threat-" + threat.level : "");

        var time = new Date().toLocaleTimeString();
        var langInfo = CONFIG.LANGUAGES[lang] || { name: lang, flag: "üåç" };
        var showBoth = original !== translated && lang !== "en";

        var html = '<div class="entry-header">' +
            '<span class="entry-time">' + time + '</span>' +
            '<span class="entry-lang">' + langInfo.flag + ' ' + langInfo.name + '</span>' +
            '<span class="entry-source">' + (lang === "en" ? "GROQ" : "GhanaNLP") + '</span>' +
            (threat ? '<span class="entry-badge ' + threat.level + '">' + threat.level + '</span>' : '') +
            '</div>';

        if (showBoth) {
            html += '<div class="entry-original">' +
                '<div class="entry-original-label">Original (' + langInfo.name + ')</div>' +
                escapeHtml(original) +
                '</div>' +
                '<div class="entry-translation-label">English Translation</div>';
        }

        html += '<div class="entry-translation">' + escapeHtml(translated) + '</div>';

        if (threat) {
            html += '<div class="entry-threat">' +
                '<div class="entry-threat-header">' +
                '<span class="entry-threat-cat">' + threat.category + '</span>' +
                '<span class="entry-threat-conf">' + threat.confidence + '%</span>' +
                '</div>' +
                '<div class="entry-threat-pattern">Pattern: "' + escapeHtml(threat.pattern) + '"</div>' +
                '</div>';
        }

        entry.innerHTML = html;
        DOM.transcript.appendChild(entry);
        entry.scrollIntoView({ behavior: "smooth", block: "end" });
    }

    function triggerAlert(threat, translated, original) {
        log("üö® ALERT: " + threat.level.toUpperCase() + " - " + threat.category, "error");

        if (navigator.vibrate) {
            var pattern = threat.level === "critical" ? [200, 100, 200, 100, 200, 100, 200] : [200, 100, 200, 100, 200];
            navigator.vibrate(pattern);
        }

        playAlertSound(threat.level);

        DOM.alertHeader.className = "alert-header " + threat.level;
        DOM.alertLevel.textContent = threat.level.toUpperCase() + " THREAT";
        DOM.alertCategory.textContent = threat.category;
        DOM.alertTime.textContent = new Date().toLocaleString();
        DOM.alertTranscript.textContent = original + (translated !== original ? "\n\n‚Üí " + translated : "");
        DOM.alertConfidence.textContent = threat.confidence + "%";
        DOM.alertPattern.textContent = threat.pattern;
        DOM.alertDevice.textContent = state.settings.deviceName;

        if (state.location) {
            var lat = state.location.lat.toFixed(6);
            var lng = state.location.lng.toFixed(6);
            DOM.alertCoords.textContent = lat + ", " + lng;
            DOM.alertAddress.textContent = state.address || "Address unavailable";
            DOM.alertMap.src = "https://www.openstreetmap.org/export/embed.html?bbox=" +
                (parseFloat(lng) - 0.005) + "," + (parseFloat(lat) - 0.005) + "," +
                (parseFloat(lng) + 0.005) + "," + (parseFloat(lat) + 0.005) +
                "&layer=mapnik&marker=" + lat + "," + lng;
        } else {
            DOM.alertCoords.textContent = "GPS unavailable";
            DOM.alertAddress.textContent = "Enable location services";
        }

        DOM.alertOverlay.classList.add("visible");
        speakAlert(threat.level + " threat detected. " + threat.category);
    }

    function playAlertSound(level) {
        try {
            var ctx = new (window.AudioContext || window.webkitAudioContext)();
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            var freq = level === "critical" ? 880 : level === "high" ? 660 : level === "medium" ? 440 : 330;
            osc.frequency.value = freq;
            osc.type = "sine";
            gain.gain.value = 0.3;
            osc.start();
            setTimeout(function() { gain.gain.value = 0; }, 150);
            setTimeout(function() { gain.gain.value = 0.3; }, 200);
            setTimeout(function() { gain.gain.value = 0; }, 350);
            if (level === "critical" || level === "high") {
                setTimeout(function() { gain.gain.value = 0.3; }, 400);
                setTimeout(function() { gain.gain.value = 0; }, 550);
            }
            setTimeout(function() { osc.stop(); ctx.close(); }, 600);
        } catch (e) {}
    }

    function speakAlert(text) {
        if ("speechSynthesis" in window) {
            try {
                speechSynthesis.cancel();
                var utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.1;
                speechSynthesis.speak(utterance);
            } catch (e) {}
        }
    }

    function dismissAlert() {
        DOM.alertOverlay.classList.remove("visible");
    }

    function escalateAlert() {
        var phone = state.settings.securityPhone;
        if (phone) {
            window.open("tel:" + phone, "_self");
        } else {
            toast("Security phone not configured", "warning");
        }
    }

    function startLocationTracking() {
        if (!("geolocation" in navigator)) return;
        navigator.geolocation.watchPosition(
            function(position) {
                state.location = { lat: position.coords.latitude, lng: position.coords.longitude };
                fetch("https://nominatim.openstreetmap.org/reverse?lat=" + position.coords.latitude + "&lon=" + position.coords.longitude + "&format=json")
                .then(function(r) { return r.json(); })
                .then(function(data) { state.address = data.display_name || ""; })
                .catch(function() {});
            },
            function() {},
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
        );
    }

    function triggerPanic() {
        log("üÜò PANIC BUTTON", "error");
        if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100, 50, 100]);
        var threat = { level: "critical", category: "MANUAL PANIC ACTIVATION", pattern: "Panic Button", confidence: 100 };
        addTranscriptEntry("PANIC BUTTON", "Manual emergency alert", "en", threat);
        triggerAlert(threat, "Manual emergency alert", "PANIC BUTTON PRESSED");
        syncToFirebase("PANIC BUTTON", "Manual emergency alert", "en", threat);
    }

    function activate() {
        state.active = true;
        DOM.statusBadge.className = "status active";
        DOM.statusText.textContent = "ACTIVE";
        DOM.btnActivate.classList.add("hidden");
        DOM.activeControls.classList.add("visible");

        startAudioCapture();
        startLocationTracking();

        var lang = state.settings.language;
        toast("OGUN Active - " + CONFIG.LANGUAGES[lang].name, "success");
        log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "success");
        log("    OGUN V9 ACTIVATED - " + CONFIG.LANGUAGES[lang].name.toUpperCase(), "success");
        log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "success");
    }

    function deactivate() {
        state.active = false;
        stopAudioCapture();
        DOM.statusBadge.className = "status standby";
        DOM.statusText.textContent = "STANDBY";
        DOM.btnActivate.classList.remove("hidden");
        DOM.activeControls.classList.remove("visible");
        toast("OGUN Deactivated");
        log("OGUN V9 DEACTIVATED");
    }

    function initEventListeners() {
        DOM.btnActivate.addEventListener("click", activate);
        DOM.btnDeactivate.addEventListener("click", deactivate);
        DOM.btnPanic.addEventListener("click", triggerPanic);
        DOM.btnSettings.addEventListener("click", function() { DOM.settingsModal.classList.add("visible"); });
        DOM.btnCloseSettings.addEventListener("click", function() { DOM.settingsModal.classList.remove("visible"); });
        DOM.settingsModal.addEventListener("click", function(e) { if (e.target === DOM.settingsModal) DOM.settingsModal.classList.remove("visible"); });
        DOM.btnSaveKeys.addEventListener("click", saveAPIKeys);
        DOM.btnSaveTeam.addEventListener("click", saveTeamSettings);
        DOM.btnDismiss.addEventListener("click", dismissAlert);
        DOM.btnEscalate.addEventListener("click", escalateAlert);
        DOM.btnDirections.addEventListener("click", function() {
            if (state.location) window.open("https://www.google.com/maps/dir/?api=1&destination=" + state.location.lat + "," + state.location.lng, "_blank");
        });
        DOM.debugToggle.addEventListener("click", function() { DOM.debugPanel.classList.toggle("visible"); });
        DOM.debugClear.addEventListener("click", function() { DOM.debugContent.innerHTML = ""; });
        DOM.selectLanguage.addEventListener("change", function() {
            state.settings.language = DOM.selectLanguage.value;
            save(CONFIG.STORAGE.LANGUAGE, state.settings.language);
            log("Language changed to: " + CONFIG.LANGUAGES[state.settings.language].name, "success");
        });
    }

    function init() {
        initDOM();
        log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "success");
        log("       OGUN V9 GODMODE + GhanaNLP ASR", "success");
        log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "success");
        loadSettings();
        initFirebase();
        initEventListeners();
        log("Ready - Select language and activate", "success");
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
