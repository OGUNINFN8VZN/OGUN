<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>OGUN V10 GODMODE - HOSTILE ENVIRONMENT</title>
    <style>
        /* BATTLE-READY STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f; 
            color: #e0e0e0; 
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* HEADER - TACTICAL */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0f3460;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .version {
            font-size: 10px;
            background: #e94560;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        .header-controls {
            display: flex;
            gap: 8px;
        }
        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #e0e0e0;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .icon-btn.active { background: #e94560; }

        /* STATUS BAR - MISSION CRITICAL */
        .status-bar {
            background: #12121a;
            padding: 8px 16px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            border-bottom: 1px solid #2a2a3a;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #4ade80;
        }
        .stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }
        .stat-value.threats { color: #f59e0b; }
        .stat-value.critical { color: #ef4444; }
        .stat-value.battery { color: #3b82f6; }
        .stat-value.team { color: #8b5cf6; }

        /* WARNING BANNER - CANNOT BE IGNORED */
        .warning-banner {
            background: linear-gradient(90deg, #dc2626, #b91c1c);
            color: white;
            padding: 10px 16px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        .warning-banner.show { display: block; }

        /* MAIN CONTENT - COMBAT READY */
        .main {
            padding: 12px;
            padding-bottom: 180px;
        }

        /* TRANSCRIPT - REAL-TIME INTELL */
        .transcript {
            background: #12121a;
            border-radius: 12px;
            border: 1px solid #2a2a3a;
            min-height: 300px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .transcript-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a3a;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .transcript-content {
            padding: 12px;
        }
        .entry {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: #1a1a2e;
            border-left: 3px solid #4ade80;
        }
        .entry.threat-low { border-left-color: #3b82f6; }
        .entry.threat-medium { border-left-color: #f59e0b; background: #1a1a0e; }
        .entry.threat-high { border-left-color: #f97316; background: #1a120e; }
        .entry.threat-critical { border-left-color: #ef4444; background: #1a0e0e; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .entry-time {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
        }
        .entry-text {
            font-size: 14px;
            line-height: 1.4;
        }
        .entry-translation {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }
        .entry-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-top: 6px;
        }
        .badge-critical { background: #ef4444; color: white; }
        .badge-high { background: #f97316; color: white; }
        .badge-medium { background: #f59e0b; color: black; }
        .badge-low { background: #3b82f6; color: white; }

        /* DEBUG PANEL - TECHNICAL ONLY */
        .debug-panel {
            background: #0a0a0f;
            border: 1px solid #2a2a3a;
            border-radius: 12px;
            margin-top: 12px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        .debug-panel.show { display: block; }
        .debug-header {
            padding: 8px 12px;
            background: #1a1a2e;
            border-bottom: 1px solid #2a2a3a;
            font-size: 12px;
            font-weight: 600;
            border-radius: 12px 12px 0 0;
        }
        .debug-content {
            padding: 8px;
            font-family: monospace;
            font-size: 11px;
        }
        .debug-line {
            padding: 2px 4px;
            border-bottom: 1px solid #1a1a2e;
        }
        .debug-line.error { color: #ef4444; }
        .debug-line.warn { color: #f59e0b; }
        .debug-line.ok { color: #4ade80; }
        .debug-line.info { color: #3b82f6; }

        /* CONTROLS - ONE-HAND OPERATION */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(0deg, #0a0a0f 0%, #0a0a0f 80%, transparent 100%);
            padding: 20px 16px;
            padding-top: 40px;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-activate {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
        }
        .btn-activate:hover { transform: scale(1.02); }
        .btn-activate:disabled { background: #374151; color: #6b7280; }
        .btn-deactivate {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            display: none;
        }
        .btn-panic {
            background: linear-gradient(135deg, #7c2d12, #dc2626);
            color: white;
            flex: 0.4;
        }
        .btn-export {
            background: #1e40af;
            color: white;
            flex: 0.4;
        }
        .status-text {
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        .status-text.active { color: #4ade80; }

        /* MODALS - QUICK CONFIG */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #1a1a2e;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #2a2a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-body {
            padding: 16px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            background: #0a0a0f;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }
        .form-input:focus {
            outline: none;
            border-color: #e94560;
        }
        .form-hint {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }
        .form-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 8px;
        }
        .form-status.ok { background: #065f46; color: #4ade80; }
        .form-status.missing { background: #7c2d12; color: #fca5a5; }
        .btn-save {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .divider {
            border-top: 1px solid #2a2a3a;
            margin: 16px 0;
        }
        .info-box {
            background: #0a0a0f;
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
        }
        .info-box-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #e94560;
        }

        /* ALERT OVERLAY - CANNOT BE MISSED */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            z-index: 2000;
            overflow-y: auto;
        }
        .alert-overlay.show { display: flex; }
        .alert-overlay.critical { background: rgba(127,29,29,0.98); }
        .alert-overlay.high { background: rgba(124,45,18,0.98); }
        
        .alert-header {
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        .alert-level {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        .alert-level.critical { color: #fca5a5; }
        .alert-level.high { color: #fdba74; }
        .alert-category {
            font-size: 28px;
            font-weight: 700;
            color: white;
        }
        .alert-time {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 8px;
        }
        
        .alert-body {
            flex: 1;
            padding: 20px;
        }
        .alert-section {
            margin-bottom: 20px;
        }
        .alert-section-title {
            font-size: 10px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 6px;
        }
        .alert-section-content {
            font-size: 16px;
            color: white;
        }
        .alert-map {
            width: 100%;
            height: 200px;
            background: #1a1a2e;
            border-radius: 12px;
            overflow: hidden;
        }
        .alert-map iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .alert-actions {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }
        .alert-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .alert-btn-security {
            background: #dc2626;
            color: white;
        }
        .alert-btn-directions {
            background: #2563eb;
            color: white;
        }
        .alert-btn-dismiss {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .alert-btn-false {
            background: transparent;
            color: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* TOAST - QUICK NOTIFICATIONS */
        .toast {
            position: fixed;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a2e;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 3000;
            display: none;
            border: 1px solid #2a2a3a;
        }
        .toast.show { display: block; }
        .toast.error { background: #7c2d12; border-color: #dc2626; }
        .toast.success { background: #065f46; border-color: #10b981; }

        /* BATTERY INDICATOR */
        .battery-low { color: #ef4444 !important; animation: pulse-red 2s infinite; }
    </style>
</head>
<body>
    <!-- HEADER - TEAM ID -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üëÅ</div>
            <span class="logo-text">OGUN</span>
            <span class="version">V10-GODMODE</span>
        </div>
        <div class="header-controls">
            <button class="icon-btn" id="btnDebug" title="Debug">üêõ</button>
            <button class="icon-btn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- WARNING BANNER -->
    <div class="warning-banner" id="warningBanner">
        ‚ö†Ô∏è GROQ API KEY REQUIRED ‚Äî Open Settings to configure
    </div>

    <!-- STATUS BAR - MISSION STATUS -->
    <div class="status-bar">
        <div class="stat">
            <div class="stat-value" id="statRuntime">00:00</div>
            <div class="stat-label">Runtime</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="statProcessed">0</div>
            <div class="stat-label">Processed</div>
        </div>
        <div class="stat">
            <div class="stat-value threats" id="statThreats">0</div>
            <div class="stat-label">Threats</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="statLang">--</div>
            <div class="stat-label">Language</div>
        </div>
        <div class="stat">
            <div class="stat-value battery" id="statBattery">100%</div>
            <div class="stat-label">Battery</div>
        </div>
    </div>

    <!-- MAIN CONTENT - INTELLIGENCE DISPLAY -->
    <main class="main">
        <div class="transcript">
            <div class="transcript-header">
                <span>üìù Live Transcript</span>
                <span id="transcriptCount">0 entries</span>
            </div>
            <div class="transcript-content" id="transcriptContent">
                <div style="text-align: center; color: #666; padding: 40px;">
                    Press ACTIVATE to begin monitoring
                </div>
            </div>
        </div>

        <div class="debug-panel" id="debugPanel">
            <div class="debug-header">üêõ Debug Console</div>
            <div class="debug-content" id="debugContent"></div>
        </div>
    </main>

    <!-- CONTROLS - ONE-HAND OPERATION -->
    <div class="controls">
        <div class="control-buttons">
            <button class="btn btn-activate" id="btnActivate">ACTIVATE OGUN</button>
            <button class="btn btn-deactivate" id="btnDeactivate">DEACTIVATE</button>
            <button class="btn btn-panic" id="btnPanic">üö®</button>
            <button class="btn btn-export" id="btnExport">üì§</button>
        </div>
        <div class="status-text" id="statusText">System ready</div>
    </div>

    <!-- SETTINGS MODAL - QUICK CONFIG -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚öôÔ∏è Settings</span>
                <button class="modal-close" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Device Name</label>
                    <input type="text" class="form-input" id="inputDeviceName" placeholder="e.g., Team Lead Phone">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Groq API Key (Required)
                        <span class="form-status missing" id="groqStatus">Not configured</span>
                    </label>
                    <input type="password" class="form-input" id="inputGroqKey" placeholder="gsk_...">
                    <div class="form-hint">Get key from console.groq.com ‚Üí API Keys</div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        GhanaNLP Key (Optional Override)
                        <span class="form-status ok" id="gnlpStatus">Embedded ‚úì</span>
                    </label>
                    <input type="password" class="form-input" id="inputGnlpKey" placeholder="Leave empty to use embedded key">
                </div>

                <div class="form-group">
                    <label class="form-label">Security Phone</label>
                    <input type="tel" class="form-input" id="inputSecurityPhone" placeholder="+233...">
                </div>

                <div class="form-group">
                    <label class="form-label">Team Code</label>
                    <input type="text" class="form-input" id="inputTeamCode" placeholder="e.g., ALPHA01">
                </div>

                <div class="form-group">
                    <label class="form-label">Whisper Model</label>
                    <select class="form-input" id="inputModel">
                        <option value="whisper-large-v3-turbo">Turbo (faster)</option>
                        <option value="whisper-large-v3">Large V3 (more accurate)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Earpiece Mode</label>
                    <select class="form-input" id="inputEarpieceMode">
                        <option value="always" selected>Always speak translations</option>
                        <option value="threats">Only speak threats</option>
                        <option value="silent">Silent (alerts only)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Battery Mode</label>
                    <select class="form-input" id="inputBatteryMode">
                        <option value="performance">Max Performance</option>
                        <option value="balanced" selected>Balanced</option>
                        <option value="survival">Survival (24hr+)</option>
                    </select>
                </div>

                <button class="btn-save" id="btnSaveSettings">Save Settings</button>

                <div class="divider"></div>

                <div class="info-box">
                    <div class="info-box-title">Duress Code</div>
                    "Call my mom" ‚Äî triggers silent CRITICAL alert
                </div>

                <div class="info-box" style="margin-top: 12px;">
                    <div class="info-box-title">Supported Languages</div>
                    üá¨üá≠ Twi ‚Ä¢ Ga ‚Ä¢ Ewe ‚Ä¢ Dagbani ‚Ä¢ Fante<br>
                    üá≥üá¨ Hausa ‚Ä¢ Yoruba ‚Ä¢ Pidgin<br>
                    üåç English
                </div>
            </div>
        </div>
    </div>

    <!-- ALERT OVERLAY - CANNOT BE IGNORED -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-header">
            <div class="alert-level" id="alertLevel">CRITICAL THREAT</div>
            <div class="alert-category" id="alertCategory">DIRECT VIOLENCE</div>
            <div class="alert-time" id="alertTime"></div>
        </div>
        <div class="alert-body">
            <div class="alert-section">
                <div class="alert-section-title">Detected Speech</div>
                <div class="alert-section-content" id="alertOriginal"></div>
            </div>
            <div class="alert-section" id="alertTranslationSection">
                <div class="alert-section-title">Translation</div>
                <div class="alert-section-content" id="alertTranslation"></div>
            </div>
            <div class="alert-section">
                <div class="alert-section-title">Location</div>
                <div class="alert-section-content" id="alertLocation">Acquiring GPS...</div>
            </div>
            <div class="alert-section">
                <div class="alert-map" id="alertMap"></div>
            </div>
            <div class="alert-section">
                <div class="alert-section-title">Device</div>
                <div class="alert-section-content" id="alertDevice"></div>
            </div>
        </div>
        <div class="alert-actions">
            <button class="alert-btn alert-btn-security" id="alertBtnSecurity">üìû CALL SECURITY</button>
            <button class="alert-btn alert-btn-directions" id="alertBtnDirections">üó∫Ô∏è GET DIRECTIONS</button>
            <button class="alert-btn alert-btn-dismiss" id="alertBtnDismiss">‚úì ACKNOWLEDGE & DISMISS</button>
            <button class="alert-btn alert-btn-false" id="alertBtnFalse">‚úó FALSE ALARM</button>
        </div>
    </div>

    <!-- TOAST - QUICK NOTIFICATIONS -->
    <div class="toast" id="toast"></div>

    <!-- FIREBASE - TEAM SYNC -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

    <script>
    (function() {
        'use strict';

        // ============================================================
        // CONFIGURATION - MISSION CRITICAL
        // ============================================================
        const CFG = {
            // API Endpoints
            GROQ_URL: 'https://api.groq.com/openai/v1/audio/transcriptions',
            GHANANLP_URL: 'https://translation-api.ghananlp.org/v1/translate',
            GHANANLP_KEY: '92071e0028a447f29076884ce4811942',
            
            // Firebase
            FB: {
                apiKey: "AIzaSyAiI07Y2Erzo7TIOoyOiXpiZIk7HoUyn8c",
                authDomain: "ogun-guardian-v1.firebaseapp.com",
                projectId: "ogun-guardian-v1",
                databaseURL: "https://ogun-guardian-v1-default-rtdb.europe-west1.firebasedatabase.app"
            },
            
            // Contacts
            ADMIN_EMAIL: 'infn.ogun@gmail.com',
            SECURITY_EMAIL: 'ogunsecure@gmail.com',
            
            // Languages with translation pairs
            LANGS: {
                'tw': { n: 'Twi', f: 'üá¨üá≠', p: 'tw-en' },
                'ak': { n: 'Akan', f: 'üá¨üá≠', p: 'tw-en' },
                'ee': { n: 'Ewe', f: 'üá¨üá≠', p: 'ee-en' },
                'gaa': { n: 'Ga', f: 'üá¨üá≠', p: 'gaa-en' },
                'dag': { n: 'Dagbani', f: 'üá¨üá≠', p: 'dag-en' },
                'fat': { n: 'Fante', f: 'üá¨üá≠', p: 'fat-en' },
                'ha': { n: 'Hausa', f: 'üá≥üá¨', p: 'ha-en' },
                'yo': { n: 'Yoruba', f: 'üá≥üá¨', p: 'yo-en' },
                'pcm': { n: 'Pidgin', f: 'üá≥üá¨', p: 'en' },
                'en': { n: 'English', f: 'üåç', p: null }
            },
            
            // Duress codes - EXPANDED FOR HOSTILE ENV
            DURESS: [
                'call my mom', 'call my mum', 'call my mother',
                'phone my mom', 'phone my mum', 'phone my mother',
                'i need to call home', 'need to call home',
                'fre me maame', 'fr…õ me maame', 'call maame',
                'check on my mother', 'how is mom', 'mom okay',
                'emergency code red', 'code red', 'situation red',
                'activate protocol', 'protocol alpha', 'alpha protocol'
            ],

            // Battery modes (chunk duration in ms)
            BATTERY_MODES: {
                performance: 3000,   // 3 seconds - fast response
                balanced: 5000,      // 5 seconds - default
                survival: 10000      // 10 seconds - max battery
            }
        };

        // ============================================================
        // THREAT PATTERNS - EXPANDED FOR HOSTILE ENV
        // ============================================================
        const THREATS = {
            critical: [
                // Direct violence
                { p: /\b(kill|murder|execute|eliminate)\s+(them|him|her|those|the)/i, c: 'DIRECT VIOLENCE', w: 100 },
                { p: /\bkill\s*them/i, c: 'KILL THREAT', w: 100 },
                { p: /\bkum\s*(won|w…în|them)/i, c: 'TWI - KILL THEM', w: 100 },
                { p: /\b(shoot|stab|slash|cut)\s+(them|him|her)/i, c: 'PHYSICAL ASSAULT', w: 95 },
                { p: /\blet'?s\s+(kill|attack|get|finish)\s+(them|him|her)/i, c: 'COORDINATED ATTACK', w: 98 },
                { p: /\b(gun|pistol|rifle|ak47|ak-47)\b/i, c: 'FIREARM MENTION', w: 92 },
                { p: /\b(tuo|tuwo|two)\b.*\b(ready|bring|get)/i, c: 'TWI - GUN READY', w: 94 },
                { p: /\b(knife|cutlass|machete|sekan|seken)\b/i, c: 'BLADE WEAPON', w: 90 },
                { p: /\bambush\b/i, c: 'AMBUSH PLANNING', w: 95 },
                { p: /\btrap\s+them/i, c: 'TRAP PLANNING', w: 94 },
                { p: /\bblock\s+(the\s+)?(road|exit|path)/i, c: 'BLOCKING ESCAPE', w: 93 },
                { p: /\bsi\s*(kwan|kwanso)/i, c: 'TWI - BLOCK ROAD', w: 93 },
                { p: /\b(attack|strike|move|do\s*it)\s*(now|tonight|today)/i, c: 'IMMINENT ACTION', w: 96 },
                { p: /\bno\s*(witness|witnesses)/i, c: 'WITNESS ELIMINATION', w: 98 },
                { p: /\bleave\s*no\s*trace/i, c: 'COVER UP', w: 94 },
                { p: /\b(bury|dump)\s*(the\s*)?(body|bodies|them)/i, c: 'BODY DISPOSAL', w: 97 },
                { p: /\b(grab|snatch|kidnap|abduct)\s*(them|him|her)/i, c: 'KIDNAPPING', w: 95 },
                { p: /\bkyere\s*(won|no|w…în)/i, c: 'TWI - CAPTURE THEM', w: 94 },
                { p: /\btie\s*(them|him|her)\s*up/i, c: 'RESTRAINT', w: 93 },
                { p: /\bfinish\s*(them|him|her|it)\s*(off)?/i, c: 'FINISH OFF', w: 94 },
                { p: /\bwie\s*(won|no|w…în)/i, c: 'TWI - FINISH THEM', w: 94 },
                { p: /\b(explosive|bomb|grenade|dynamite)\b/i, c: 'EXPLOSIVE DEVICE', w: 99 },
                { p: /\b(poison|contaminate|toxic)\b/i, c: 'POISON THREAT', w: 96 }
            ],
            high: [
                // Surveillance
                { p: /\bfollow\s*(them|him|her|the)/i, c: 'SURVEILLANCE', w: 82 },
                { p: /\bdi\s*(won|w…în)\s*akyi/i, c: 'TWI - FOLLOW THEM', w: 83 },
                { p: /\btrack\s*(them|him|her|the)/i, c: 'TRACKING', w: 82 },
                { p: /\bwatch\s*(them|him|her|the|where)/i, c: 'WATCHING', w: 78 },
                { p: /\bhw[e…õ]\s*(won|w…în)/i, c: 'TWI - WATCH THEM', w: 80 },
                // Theft
                { p: /\bsteal\s*(the\s*)?(gold|equipment|money|vehicle)/i, c: 'THEFT PLANNING', w: 85 },
                { p: /\bwia\b/i, c: 'TWI - STEAL', w: 86 },
                { p: /\bb[o…î]\s*(won|w…în)\s*kor[o…î]no/i, c: 'TWI - ROB THEM', w: 87 },
                { p: /\brob\s*(them|the)/i, c: 'ROBBERY', w: 86 },
                // Reinforcement
                { p: /\bcall\s*(the\s*)?(boys|guys|men|others)/i, c: 'CALLING BACKUP', w: 84 },
                { p: /\bfr[e…õ]\s*(mmarima|nkur[o…î]fo)/i, c: 'TWI - CALL THE MEN', w: 85 },
                // Corruption
                { p: /\bbribe\s*(the\s*)?(police|chief|officer)/i, c: 'BRIBERY', w: 80 },
                { p: /\bpay\s*(off|them)\s*(the\s*)?(police|chief)?/i, c: 'PAYOFF', w: 78 }
            ],
            medium: [
                // Intel gathering
                { p: /\bhow\s*many\s*(of\s*)?(them|guards|people|are)/i, c: 'NUMBER PROBE', w: 68 },
                { p: /\bwho\s*(is\s*)?(guarding|watching|protecting)/i, c: 'SECURITY PROBE', w: 70 },
                // Assets
                { p: /\b(their|the)\s*(gold|equipment|machines?|vehicles?)/i, c: 'ASSET INTEREST', w: 62 },
                { p: /\bsika\s*k[o…î]k[o…î][o…î]/i, c: 'TWI - GOLD', w: 65 },
                // Context
                { p: /\bgalamsey\b/i, c: 'GALAMSEY CONTEXT', w: 55 },
                { p: /\billegal\s*mining/i, c: 'ILLEGAL MINING', w: 58 }
            ],
            low: [
                { p: /\bpolice\b/i, c: 'POLICE MENTION', w: 40 },
                { p: /\bsecurity\b/i, c: 'SECURITY MENTION', w: 35 },
                { p: /\bproblem\b/i, c: 'PROBLEM MENTION', w: 30 },
                { p: /\btrouble\b/i, c: 'TROUBLE MENTION', w: 35 }
            ]
        };

        // ============================================================
        // STATE - MISSION CRITICAL
        // ============================================================
        const S = {
            active: false,
            mediaRecorder: null,
            audioChunks: [],
            startTime: null,
            runtimeInterval: null,
            wakeLock: null,
            position: null,
            db: null,
            processed: 0,
            threats: 0,
            entries: [],
            batteryLevel: 100,
            batteryInterval: null,
            teamCode: '',
            
            keys: {
                groq: localStorage.getItem('ogun_groq_key') || '',
                gnlp: localStorage.getItem('ogun_gnlp_key') || ''
            },
            
            settings: {
                deviceName: localStorage.getItem('ogun_device_name') || 'Guardian-' + Math.random().toString(36).substr(2, 4),
                securityPhone: localStorage.getItem('ogun_security_phone') || '+233000000000',
                teamCode: localStorage.getItem('ogun_team_code') || '',
                model: localStorage.getItem('ogun_model') || 'whisper-large-v3-turbo',
                batteryMode: localStorage.getItem('ogun_battery_mode') || 'balanced',
                earpieceMode: localStorage.getItem('ogun_earpiece_mode') || 'always',
                volume: parseFloat(localStorage.getItem('ogun_volume')) || 0.7
            },
            
            currentAlert: null,
            lastPosition: null,
            movementCheck: null,
            audioContext: null
        };

        // ============================================================
        // DOM ELEMENTS
        // ============================================================
        const $ = id => document.getElementById(id);
        const DOM = {
            warningBanner: $('warningBanner'),
            statRuntime: $('statRuntime'),
            statProcessed: $('statProcessed'),
            statThreats: $('statThreats'),
            statLang: $('statLang'),
            statBattery: $('statBattery'),
            transcriptContent: $('transcriptContent'),
            transcriptCount: $('transcriptCount'),
            debugPanel: $('debugPanel'),
            debugContent: $('debugContent'),
            btnActivate: $('btnActivate'),
            btnDeactivate: $('btnDeactivate'),
            btnPanic: $('btnPanic'),
            btnExport: $('btnExport'),
            btnDebug: $('btnDebug'),
            btnSettings: $('btnSettings'),
            statusText: $('statusText'),
            settingsModal: $('settingsModal'),
            closeSettings: $('closeSettings'),
            inputDeviceName: $('inputDeviceName'),
            inputGroqKey: $('inputGroqKey'),
            inputGnlpKey: $('inputGnlpKey'),
            inputSecurityPhone: $('inputSecurityPhone'),
            inputTeamCode: $('inputTeamCode'),
            inputModel: $('inputModel'),
            inputEarpieceMode: $('inputEarpieceMode'),
            inputBatteryMode: $('inputBatteryMode'),
            btnSaveSettings: $('btnSaveSettings'),
            groqStatus: $('groqStatus'),
            alertOverlay: $('alertOverlay'),
            alertLevel: $('alertLevel'),
            alertCategory: $('alertCategory'),
            alertTime: $('alertTime'),
            alertOriginal: $('alertOriginal'),
            alertTranslation: $('alertTranslation'),
            alertTranslationSection: $('alertTranslationSection'),
            alertLocation: $('alertLocation'),
            alertMap: $('alertMap'),
            alertDevice: $('alertDevice'),
            alertBtnSecurity: $('alertBtnSecurity'),
            alertBtnDirections: $('alertBtnDirections'),
            alertBtnDismiss: $('alertBtnDismiss'),
            alertBtnFalse: $('alertBtnFalse'),
            toast: $('toast')
        };

        // ============================================================
        // DEBUG LOGGING
        // ============================================================
        function dbg(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = 'debug-line ' + type;
            line.textContent = `[${time}] ${msg}`;
            DOM.debugContent.insertBefore(line, DOM.debugContent.firstChild);
            if (DOM.debugContent.children.length > 100) {
                DOM.debugContent.removeChild(DOM.debugContent.lastChild);
            }
            console.log(`[OGUN ${type.toUpperCase()}]`, msg);
        }

        // ============================================================
        // TOAST NOTIFICATIONS
        // ============================================================
        function toast(msg, type = '') {
            DOM.toast.textContent = msg;
            DOM.toast.className = 'toast show ' + type;
            setTimeout(() => DOM.toast.classList.remove('show'), 3000);
        }

        // ============================================================
        // FIREBASE INIT
        // ============================================================
        function initFirebase() {
            try {
                firebase.initializeApp(CFG.FB);
                S.db = firebase.database();
                dbg('Firebase connected', 'ok');
                
                // Listen for team alerts
                if (S.settings.teamCode) {
                    S.db.ref('team_alerts/' + S.settings.teamCode).on('child_added', (snapshot) => {
                        const alert = snapshot.val();
                        if (alert.device !== S.settings.deviceName) {
                            handleTeamAlert(alert);
                        }
                    });
                }
            } catch (e) {
                dbg('Firebase error: ' + e.message, 'error');
            }
        }

        // ============================================================
        // SETTINGS
        // ============================================================
        function loadSettings() {
            DOM.inputDeviceName.value = S.settings.deviceName;
            DOM.inputGroqKey.value = S.keys.groq;
            DOM.inputGnlpKey.value = S.keys.gnlp;
            DOM.inputSecurityPhone.value = S.settings.securityPhone;
            DOM.inputTeamCode.value = S.settings.teamCode;
            DOM.inputModel.value = S.settings.model;
            DOM.inputEarpieceMode.value = S.settings.earpieceMode;
            DOM.inputBatteryMode.value = S.settings.batteryMode;
            updateGroqStatus();
        }

        function saveSettings() {
            S.settings.deviceName = DOM.inputDeviceName.value.trim() || S.settings.deviceName;
            S.keys.groq = DOM.inputGroqKey.value.trim();
            S.keys.gnlp = DOM.inputGnlpKey.value.trim();
            S.settings.securityPhone = DOM.inputSecurityPhone.value.trim() || S.settings.securityPhone;
            S.settings.teamCode = DOM.inputTeamCode.value.trim().toUpperCase();
            S.settings.model = DOM.inputModel.value;
            S.settings.earpieceMode = DOM.inputEarpieceMode.value;
            S.settings.batteryMode = DOM.inputBatteryMode.value;

            localStorage.setItem('ogun_device_name', S.settings.deviceName);
            localStorage.setItem('ogun_groq_key', S.keys.groq);
            localStorage.setItem('ogun_gnlp_key', S.keys.gnlp);
            localStorage.setItem('ogun_security_phone', S.settings.securityPhone);
            localStorage.setItem('ogun_team_code', S.settings.teamCode);
            localStorage.setItem('ogun_model', S.settings.model);
            localStorage.setItem('ogun_earpiece_mode', S.settings.earpieceMode);
            localStorage.setItem('ogun_battery_mode', S.settings.batteryMode);

            updateGroqStatus();
            DOM.settingsModal.classList.remove('show');
            toast('Settings saved', 'success');
            dbg('Settings saved', 'ok');
            
            // Update Firebase team registration
            if (S.db && S.settings.teamCode) {
                S.db.ref('team_devices/' + S.settings.teamCode + '/' + S.settings.deviceName).set({
                    name: S.settings.deviceName,
                    lastSeen: Date.now(),
                    battery: S.batteryLevel
                });
            }
        }

        function updateGroqStatus() {
            if (S.keys.groq) {
                DOM.groqStatus.textContent = 'Configured ‚úì';
                DOM.groqStatus.className = 'form-status ok';
                DOM.warningBanner.classList.remove('show');
            } else {
                DOM.groqStatus.textContent = 'Not configured';
                DOM.groqStatus.className = 'form-status missing';
                DOM.warningBanner.classList.add('show');
            }
        }

        // ============================================================
        // BATTERY MANAGEMENT
        // ============================================================
        function initBatteryMonitoring() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    updateBattery(battery);
                    battery.addEventListener('levelchange', () => updateBattery(battery));
                    battery.addEventListener('chargingchange', () => updateBattery(battery));
                });
            }
            
            S.batteryInterval = setInterval(() => {
                // Simulate battery drain when active
                if (S.active && S.batteryLevel > 0) {
                    const drainRate = S.settings.batteryMode === 'survival' ? 0.01 : 
                                    S.settings.batteryMode === 'balanced' ? 0.02 : 0.05;
                    S.batteryLevel = Math.max(0, S.batteryLevel - drainRate);
                    DOM.statBattery.textContent = Math.round(S.batteryLevel) + '%';
                    if (S.batteryLevel < 20) {
                        DOM.statBattery.classList.add('battery-low');
                        if (S.batteryLevel < 10 && S.active) {
                            toast('‚ö†Ô∏è CRITICAL BATTERY - Switch to survival mode', 'error');
                        }
                    }
                }
            }, 60000); // Update every minute
        }

        function updateBattery(battery) {
            S.batteryLevel = Math.round(battery.level * 100);
            DOM.statBattery.textContent = S.batteryLevel + '%';
            if (S.batteryLevel < 20) {
                DOM.statBattery.classList.add('battery-low');
            } else {
                DOM.statBattery.classList.remove('battery-low');
            }
        }

        // ============================================================
        // AUDIO CAPTURE
        // ============================================================
        async function startAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    } 
                });

                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
                S.mediaRecorder = new MediaRecorder(stream, { mimeType });
                dbg('MediaRecorder using: ' + mimeType, 'ok');

                S.mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        S.audioChunks.push(e.data);
                    }
                };

                S.mediaRecorder.onstop = async () => {
                    if (S.audioChunks.length > 0) {
                        const blob = new Blob(S.audioChunks, { type: mimeType });
                        S.audioChunks = [];
                        if (blob.size > 1000) {
                            await processAudio(blob);
                        }
                    }
                    if (S.active) {
                        S.mediaRecorder.start();
                        setTimeout(() => {
                            if (S.active && S.mediaRecorder.state === 'recording') {
                                S.mediaRecorder.stop();
                            }
                        }, CFG.BATTERY_MODES[S.settings.batteryMode]);
                    }
                };

                S.mediaRecorder.start();
                setTimeout(() => {
                    if (S.active && S.mediaRecorder.state === 'recording') {
                        S.mediaRecorder.stop();
                    }
                }, CFG.BATTERY_MODES[S.settings.batteryMode]);

                dbg('Audio capture started', 'ok');

            } catch (e) {
                dbg('Microphone error: ' + e.message, 'error');
                toast('Microphone access denied', 'error');
                deactivate();
            }
        }

        // ============================================================
        // GROQ WHISPER TRANSCRIPTION
        // ============================================================
        async function transcribeGroq(blob) {
            if (!S.keys.groq) {
                dbg('No Groq key', 'error');
                return null;
            }

            try {
                const fd = new FormData();
                fd.append('file', blob, 'audio.webm');
                fd.append('model', S.settings.model);
                fd.append('response_format', 'json');
                fd.append('language', 'en');

                const r = await fetch(CFG.GROQ_URL, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + S.keys.groq },
                    body: fd
                });

                if (!r.ok) {
                    const err = await r.text();
                    throw new Error('Groq ' + r.status + ': ' + err);
                }

                const data = await r.json();
                dbg('Groq transcribed: ' + (data.text || '').substring(0, 50), 'ok');
                return data.text || '';

            } catch (e) {
                dbg('Groq error: ' + e.message, 'error');
                return null;
            }
        }

        // ============================================================
        // LANGUAGE DETECTION - IMPROVED
        // ============================================================
        function detectLanguage(text) {
            const lower = text.toLowerCase();
            
            // Special characters
            if (/[…õ…î≈ã∆ê∆Ü≈ä]/.test(text)) return 'tw';
            
            // Twi patterns
            const twiPatterns = [
                /\b(y…õ|k…î|b…õ|w…î|…õy…õ|s…õ|nso|anaa|daabi|aane|medaase|mepa|kyer…õ|hw…õ|fa)\b/i,
                /\b(kum|wia|obroni|sika|maame|agya|…îhene|asem|adwuma|efie|…îmo|koraa)\b/i
            ];
            for (const p of twiPatterns) if (p.test(lower)) return 'tw';
            
            // Hausa
            const hausaPatterns = [
                /\b(zan|zai|zasu|kana|tana|yana|muna|suna|cikin|akan|daga|zuwa)\b/i,
                /\b(kuma|amma|saboda|domin|wannan|wancan|ina|yaya|mene)\b/i
            ];
            for (const p of hausaPatterns) if (p.test(lower)) return 'ha';
            
            // Ewe
            const ewePatterns = [
                /\b(…ñe|∆íe|a∆íe|mi…ño|w√≤le|√®le|m√≠ele|woaw…î|agbe|x…î|…ñeka)\b/i
            ];
            for (const p of ewePatterns) if (p.test(lower)) return 'ee';
            
            // Pidgin
            const pidginPatterns = [
                /\b(na\s+so|abi|oga|wahala|chop|wetin|how\s+you|i\s+go)\b/i
            ];
            for (const p of pidginPatterns) if (p.test(lower)) return 'pcm';
            
            return 'en';
        }

        // ============================================================
        // TRANSLATION - MULTI-PROVIDER FALLBACK
        // ============================================================
        async function translate(text, lang) {
            // Try GhanaNLP first
            let result = await translateGNLP(text, lang);
            if (result && result !== text) return result;

            // Try LibreTranslate
            result = await translateLibre(text);
            if (result && result !== text) return result;

            // Fallback to Google
            dbg('Falling back to Google Translate', 'warn');
            return await translateGoogle(text, lang);
        }

        async function translateGNLP(text, lang) {
            try {
                const lc = CFG.LANGS[lang];
                if (!lc || !lc.p) return null;

                const key = S.keys.gnlp || CFG.GHANANLP_KEY;
                if (!key) return null;

                const r = await fetch(CFG.GHANANLP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Ocp-Apim-Subscription-Key': key
                    },
                    body: JSON.stringify({ in: text, lang: lc.p })
                });

                if (!r.ok) throw new Error('GNLP ' + r.status);

                const t = await r.text();
                dbg('GhanaNLP translated', 'ok');
                return t;

            } catch (e) {
                dbg('GhanaNLP error: ' + e.message, 'warn');
                return null;
            }
        }

        async function translateLibre(text) {
            try {
                const r = await fetch('https://libretranslate.com/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        q: text,
                        source: 'auto',
                        target: 'en'
                    })
                });
                
                if (!r.ok) throw new Error('Libre ' + r.status);
                
                const data = await r.json();
                return data.translatedText || null;
                
            } catch (e) {
                dbg('LibreTranslate error', 'warn');
                return null;
            }
        }

        async function translateGoogle(text, lang) {
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${lang}&tl=en&dt=t&q=${encodeURIComponent(text)}`;
                const r = await fetch(url);
                const data = await r.json();
                return data[0].map(x => x[0]).join('');
            } catch (e) {
                dbg('Google error', 'warn');
                return null;
            }
        }

        // ============================================================
        // PROCESS AUDIO CHUNK - ALWAYS TRANSLATE, ALWAYS SPEAK
        // ============================================================
        async function processAudio(blob) {
            if (!S.active) return;
            
            S.processed++;
            DOM.statProcessed.textContent = S.processed;

            // Transcribe
            const text = await transcribeGroq(blob);
            if (!text || text.trim().length < 2) {
                dbg('Empty transcription', 'warn');
                return;
            }

            // Detect language
            const lang = detectLanguage(text);
            DOM.statLang.textContent = CFG.LANGS[lang]?.f + ' ' + CFG.LANGS[lang]?.n || lang;

            // ALWAYS TRANSLATE (if not English)
            let translation = '';
            if (lang !== 'en') {
                translation = await translate(text, lang) || text;
                dbg('Translated: ' + translation.substring(0, 50), 'ok');
            } else {
                translation = text;
            }

            // ALWAYS SPEAK IN EARPIECE (based on mode)
            if (S.settings.earpieceMode === 'always' || 
                (S.settings.earpieceMode === 'threats' && await checkForThreats(text, translation))) {
                speak(translation);
            }

            // Analyze threat
            const threat = analyzeThreat(text, translation);

            // Create entry
            const entry = {
                id: Date.now(),
                time: new Date().toISOString(),
                text: text,
                translation: translation,
                lang: lang,
                threat: threat,
                device: S.settings.deviceName,
                position: S.position,
                battery: S.batteryLevel,
                teamCode: S.settings.teamCode
            };

            S.entries.push(entry);
            addEntryToUI(entry);

            // Handle threat
            if (threat.level !== 'none') {
                S.threats++;
                DOM.statThreats.textContent = S.threats;
                handleThreat(entry);
            }

            // Log to Firebase
            logToFirebase(entry);
        }

        async function checkForThreats(text, translation) {
            const combined = text + ' ' + translation;
            const threat = analyzeThreat(text, translation);
            return threat.level !== 'none';
        }

        // ============================================================
        // THREAT ANALYSIS
        // ============================================================
        function analyzeThreat(text, translation = '') {
            const combined = text + ' ' + (translation || '');
            const lower = combined.toLowerCase();

            // Check duress first
            if (checkDuress(combined)) {
                return { level: 'critical', category: 'DURESS CODE', weight: 100, pattern: 'duress' };
            }

            let highest = { level: 'none', category: '', weight: 0, pattern: '' };

            // Check all levels
            const levels = ['critical', 'high', 'medium', 'low'];
            for (const level of levels) {
                for (const threat of THREATS[level]) {
                    if (threat.p.test(combined)) {
                        if (threat.w > highest.weight) {
                            highest = {
                                level: level,
                                category: threat.c,
                                weight: threat.w,
                                pattern: threat.p.toString()
                            };
                        }
                    }
                }
            }

            return highest;
        }

        function checkDuress(text) {
            const lower = text.toLowerCase();
            for (const phrase of CFG.DURESS) {
                if (lower.includes(phrase)) {
                    return true;
                }
            }
            return false;
        }

        // ============================================================
        // ADD ENTRY TO UI
        // ============================================================
        function addEntryToUI(entry) {
            if (S.entries.length === 1) {
                DOM.transcriptContent.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = 'entry threat-' + entry.threat.level;

            let html = `
                <div class="entry-time">${new Date(entry.time).toLocaleTimeString()}</div>
                <div class="entry-text">${escapeHtml(entry.text)}</div>
            `;

            if (entry.translation && entry.translation !== entry.text) {
                html += `<div class="entry-translation">‚Üí ${escapeHtml(entry.translation)}</div>`;
            }

            if (entry.threat.level !== 'none') {
                html += `<span class="entry-badge badge-${entry.threat.level}">${entry.threat.level.toUpperCase()}: ${entry.threat.category}</span>`;
            }

            div.innerHTML = html;
            DOM.transcriptContent.insertBefore(div, DOM.transcriptContent.firstChild);
            DOM.transcriptCount.textContent = S.entries.length + ' entries';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================================
        // HANDLE THREAT
        // ============================================================
        function handleThreat(entry) {
            const level = entry.threat.level;

            if (level === 'critical' || level === 'high') {
                showAlertOverlay(entry);
                playAlarm(level);
                vibrate(level);
                
                // Broadcast to team
                if (S.db && S.settings.teamCode) {
                    S.db.ref('team_alerts/' + S.settings.teamCode + '/' + entry.id).set({
                        ...entry,
                        broadcast: true,
                        timestamp: Date.now()
                    });
                }

                // CALL SECURITY IMMEDIATELY
                if (level === 'critical' && S.settings.securityPhone) {
                    setTimeout(() => {
                        window.location.href = 'tel:' + S.settings.securityPhone;
                    }, 2000);
                }

            } else if (level === 'medium') {
                playBeep();
                vibrate('medium');
                toast('‚ö†Ô∏è Medium threat: ' + entry.threat.category);
            }
        }

        function handleTeamAlert(alert) {
            toast('üö® TEAM ALERT: ' + alert.device + ' - ' + alert.threat.category, 'error');
            if (alert.threat.level === 'critical') {
                playAlarm('critical');
                vibrate('critical');
            }
        }

        // ============================================================
        // ALERT OVERLAY
        // ============================================================
        function showAlertOverlay(entry) {
            S.currentAlert = entry;

            DOM.alertLevel.textContent = entry.threat.level.toUpperCase() + ' THREAT';
            DOM.alertLevel.className = 'alert-level ' + entry.threat.level;
            DOM.alertCategory.textContent = entry.threat.category;
            DOM.alertTime.textContent = new Date(entry.time).toLocaleString();
            DOM.alertOriginal.textContent = entry.text;
            
            if (entry.translation && entry.translation !== entry.text) {
                DOM.alertTranslation.textContent = entry.translation;
                DOM.alertTranslationSection.style.display = 'block';
            } else {
                DOM.alertTranslationSection.style.display = 'none';
            }

            DOM.alertDevice.textContent = entry.device;

            // Location
            if (entry.position) {
                const lat = entry.position.latitude.toFixed(6);
                const lng = entry.position.longitude.toFixed(6);
                DOM.alertLocation.textContent = `${lat}, ${lng}`;
                DOM.alertMap.innerHTML = `<iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.01}%2C${lat-0.01}%2C${lng+0.01}%2C${lat+0.01}&layer=mapnik&marker=${lat}%2C${lng}"></iframe>`;
            } else {
                DOM.alertLocation.textContent = 'GPS unavailable';
                DOM.alertMap.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">No location data</div>';
            }

            DOM.alertOverlay.className = 'alert-overlay show ' + entry.threat.level;
        }

        function hideAlertOverlay() {
            DOM.alertOverlay.classList.remove('show');
            S.currentAlert = null;
        }

        // ============================================================
        // AUDIO ALERTS
        // ============================================================
        function playBeep() {
            try {
                if (!S.audioContext) S.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const osc = S.audioContext.createOscillator();
                const gain = S.audioContext.createGain();
                osc.connect(gain);
                gain.connect(S.audioContext.destination);
                osc.frequency.value = 800;
                gain.gain.value = 0.3;
                osc.start();
                setTimeout(() => osc.stop(), 200);
            } catch (e) {}
        }

        function playAlarm(level) {
            try {
                if (!S.audioContext) S.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const freq = level === 'critical' ? 1000 : 800;
                
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const osc = S.audioContext.createOscillator();
                        const gain = S.audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(S.audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.value = 0.5;
                        osc.start();
                        setTimeout(() => osc.stop(), 300);
                    }, i * 400);
                }
            } catch (e) {}
        }

        function vibrate(level) {
            if (!navigator.vibrate) return;
            
            const patterns = {
                critical: [500, 200, 500, 200, 500],
                high: [300, 100, 300],
                medium: [200, 100, 200]
            };
            navigator.vibrate(patterns[level] || [200]);
        }

        // ============================================================
        // TEXT-TO-SPEECH - ALWAYS-ON EARPIECE
        // ============================================================
        function speak(text) {
            if (!text || !window.speechSynthesis || S.settings.earpieceMode === 'silent') {
                return;
            }
            
            try {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = S.settings.volume;
                
                const voices = window.speechSynthesis.getVoices();
                const englishVoice = voices.find(v => v.lang.startsWith('en'));
                if (englishVoice) utterance.voice = englishVoice;
                
                window.speechSynthesis.speak(utterance);
                
            } catch (e) {
                dbg('TTS error: ' + e.message, 'error');
            }
        }

        // Preload voices
        if (window.speechSynthesis) {
            window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        // ============================================================
        // FIREBASE LOGGING
        // ============================================================
        function logToFirebase(entry) {
            if (!S.db) return;
            
            try {
                // Log transcript
                S.db.ref('transcripts/' + entry.id).set(entry);
                
                // Update team device status
                if (S.settings.teamCode) {
                    S.db.ref('team_devices/' + S.settings.teamCode + '/' + S.settings.deviceName).update({
                        lastSeen: Date.now(),
                        battery: S.batteryLevel,
                        position: S.position
                    });
                }
                
            } catch (e) {
                dbg('Firebase error: ' + e.message, 'warn');
            }
        }

        // ============================================================
        // GPS TRACKING
        // ============================================================
        function startGPS() {
            if (!navigator.geolocation) {
                dbg('Geolocation not supported', 'warn');
                return;
            }

            navigator.geolocation.watchPosition(
                (pos) => {
                    S.position = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        timestamp: Date.now()
                    };
                    
                    // Check movement for man-down detection
                    if (S.lastPosition) {
                        const distance = calculateDistance(
                            S.lastPosition.latitude, S.lastPosition.longitude,
                            S.position.latitude, S.position.longitude
                        );
                        if (distance > 100) { // Moved more than 100m
                            S.movementCheck = Date.now();
                        }
                    }
                    S.lastPosition = { ...S.position };
                    
                },
                (err) => dbg('GPS error: ' + err.message, 'warn'),
                { 
                    enableHighAccuracy: S.settings.batteryMode !== 'survival',
                    maximumAge: S.settings.batteryMode === 'survival' ? 60000 : 30000,
                    timeout: 10000 
                }
            );
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ============================================================
        // WAKE LOCK
        // ============================================================
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    S.wakeLock = await navigator.wakeLock.request('screen');
                    dbg('Wake lock acquired', 'ok');
                    
                    S.wakeLock.addEventListener('release', () => {
                        dbg('Wake lock released', 'warn');
                        if (S.active) requestWakeLock();
                    });
                }
            } catch (e) {
                dbg('Wake lock failed: ' + e.message, 'warn');
            }
        }

        // ============================================================
        // RUNTIME TIMER
        // ============================================================
        function startRuntimeTimer() {
            S.startTime = Date.now();
            S.runtimeInterval = setInterval(() => {
                const elapsed = Date.now() - S.startTime;
                const mins = Math.floor(elapsed / 60000);
                const secs = Math.floor((elapsed % 60000) / 1000);
                DOM.statRuntime.textContent = 
                    mins.toString().padStart(2, '0') + ':' + 
                    secs.toString().padStart(2, '0');
                    
                // Man-down check (5 minutes no movement)
                if (S.movementCheck && (Date.now() - S.movementCheck) > 300000) {
                    triggerManDownAlert();
                    S.movementCheck = Date.now(); // Reset
                }
            }, 1000);
        }

        function stopRuntimeTimer() {
            if (S.runtimeInterval) {
                clearInterval(S.runtimeInterval);
                S.runtimeInterval = null;
            }
        }

        function triggerManDownAlert() {
            const entry = {
                id: Date.now(),
                time: new Date().toISOString(),
                text: 'MAN-DOWN ALERT - No movement for 5 minutes',
                translation: '',
                lang: 'en',
                threat: { level: 'critical', category: 'MAN DOWN', weight: 90 },
                device: S.settings.deviceName,
                position: S.position,
                battery: S.batteryLevel
            };

            S.entries.push(entry);
            addEntryToUI(entry);
            handleThreat(entry);
            logToFirebase(entry);
            
            dbg('MAN-DOWN ALERT TRIGGERED', 'error');
            toast('üö® MAN-DOWN ALERT - No movement detected', 'error');
        }

        // ============================================================
        // ACTIVATION / DEACTIVATION
        // ============================================================
        async function activate() {
            if (!S.keys.groq) {
                toast('Configure Groq API key in Settings', 'error');
                DOM.settingsModal.classList.add('show');
                return;
            }

            S.active = true;
            DOM.btnActivate.style.display = 'none';
            DOM.btnDeactivate.style.display = 'block';
            DOM.statusText.textContent = 'OGUN ACTIVE - Guardian Online';
            DOM.statusText.classList.add('active');

            await requestWakeLock();
            startGPS();
            startRuntimeTimer();
            await startAudio();

            dbg('OGUN ACTIVATED - Guardian Online', 'ok');
            toast('OGUN Activated - Guardian Online', 'success');
            
            // Send activation alert to team
            if (S.db && S.settings.teamCode) {
                S.db.ref('team_status/' + S.settings.teamCode + '/' + S.settings.deviceName).set({
                    status: 'active',
                    timestamp: Date.now(),
                    position: S.position
                });
            }
        }

        function deactivate() {
            S.active = false;

            if (S.mediaRecorder && S.mediaRecorder.state !== 'inactive') {
                S.mediaRecorder.stop();
            }
            S.mediaRecorder = null;
            S.audioChunks = [];

            if (S.wakeLock) {
                S.wakeLock.release();
                S.wakeLock = null;
            }

            stopRuntimeTimer();

            DOM.btnActivate.style.display = 'block';
            DOM.btnDeactivate.style.display = 'none';
            DOM.statusText.textContent = 'System ready';
            DOM.statusText.classList.remove('active');

            dbg('OGUN DEACTIVATED', 'warn');
            toast('OGUN Deactivated');
            
            // Send deactivation alert to team
            if (S.db && S.settings.teamCode) {
                S.db.ref('team_status/' + S.settings.teamCode + '/' + S.settings.deviceName).set({
                    status: 'inactive',
                    timestamp: Date.now()
                });
            }
        }

        // ============================================================
        // PANIC BUTTON - CANNOT FAIL
        // ============================================================
        function triggerPanic() {
            const entry = {
                id: Date.now(),
                time: new Date().toISOString(),
                text: 'üö® MANUAL PANIC BUTTON ACTIVATED üö®',
                translation: '',
                lang: 'en',
                threat: { level: 'critical', category: 'PANIC BUTTON', weight: 100 },
                device: S.settings.deviceName,
                position: S.position,
                battery: S.batteryLevel,
                teamCode: S.settings.teamCode
            };

            S.entries.push(entry);
            addEntryToUI(entry);
            handleThreat(entry);
            logToFirebase(entry);

            // CALL SECURITY IMMEDIATELY
            if (S.settings.securityPhone) {
                setTimeout(() => {
                    window.location.href = 'tel:' + S.settings.securityPhone;
                }, 1000);
            }

            dbg('PANIC BUTTON TRIGGERED', 'error');
            toast('üö® PANIC BUTTON ACTIVATED - Calling security...', 'error');
        }

        // ============================================================
        // EXPORT LOG
        // ============================================================
        function exportLog() {
            const data = JSON.stringify(S.entries, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ogun-log-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            toast('Log exported', 'success');
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        function bindEvents() {
            DOM.btnActivate.onclick = activate;
            DOM.btnDeactivate.onclick = deactivate;
            DOM.btnPanic.onclick = triggerPanic;
            DOM.btnExport.onclick = exportLog;
            
            DOM.btnDebug.onclick = () => {
                DOM.debugPanel.classList.toggle('show');
                DOM.btnDebug.classList.toggle('active');
            };
            
            DOM.btnSettings.onclick = () => {
                loadSettings();
                DOM.settingsModal.classList.add('show');
            };
            
            DOM.closeSettings.onclick = () => DOM.settingsModal.classList.remove('show');
            DOM.btnSaveSettings.onclick = saveSettings;

            // Alert buttons
            DOM.alertBtnSecurity.onclick = () => {
                window.location.href = 'tel:' + S.settings.securityPhone;
            };
            
            DOM.alertBtnDirections.onclick = () => {
                if (S.currentAlert?.position) {
                    const { latitude, longitude } = S.currentAlert.position;
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${latitude},${longitude}`, '_blank');
                }
            };
            
            DOM.alertBtnDismiss.onclick = hideAlertOverlay;
            
            DOM.alertBtnFalse.onclick = () => {
                if (S.currentAlert && S.db) {
                    S.db.ref('alerts/' + S.currentAlert.id + '/falseAlarm').set(true);
                }
                hideAlertOverlay();
                toast('Marked as false alarm');
            };

            // Close modal on overlay click
            DOM.settingsModal.onclick = (e) => {
                if (e.target === DOM.settingsModal) {
                    DOM.settingsModal.classList.remove('show');
                }
            };

            // Physical button shortcuts
            document.addEventListener('keydown', (e) => {
                // Volume up + power = panic
                if (e.key === 'VolumeUp' && e.ctrlKey) {
                    triggerPanic();
                }
                // Volume down + power = quick deactivate
                if (e.key === 'VolumeDown' && e.ctrlKey) {
                    deactivate();
                }
            });

            // Prevent accidental swipeÂÖ≥Èó≠
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });
        }

        // ============================================================
        // INIT - BATTLE READY
        // ============================================================
        function init() {
            dbg('OGUN V10 GODMODE INITIALIZING...', 'ok');
            initFirebase();
            loadSettings();
            updateGroqStatus();
            initBatteryMonitoring();
            bindEvents();
            dbg('OGUN V10 GODMODE READY - Guardian Standing By', 'ok');
            dbg('Team Code: ' + (S.settings.teamCode || 'NOT SET'), S.settings.teamCode ? 'ok' : 'warn');
            dbg('Battery Mode: ' + S.settings.batteryMode, 'info');
            dbg('Earpiece Mode: ' + S.settings.earpieceMode, 'info');
            
            // Daily report reminder
            const now = new Date();
            const reportTime = new Date();
            reportTime.setHours(6, 0, 0, 0);
            if (now > reportTime) reportTime.setDate(reportTime.getDate() + 1);
            const timeToReport = reportTime - now;
            setTimeout(() => {
                toast('üìÑ Daily report time - Check email for overnight activity');
            }, timeToReport);
        }

        // ============================================================
        // START THE GUARDIAN
        // ============================================================
        init();
    })();
    </script>
</body>
</html>
